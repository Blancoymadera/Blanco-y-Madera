<!DOCTYPE html>
<html lang="es">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat√°logo Vendedor - Blanco & Madera</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fefce8;
        }
        .item-card {
            transition: transform 0.1s ease-out;
            cursor: pointer; 
            pointer-events: auto; 
        }
        .item-card:hover {
            background-color: #fffaf0;
        }
        .amber-gradient {
            background-image: linear-gradient(to right, #d4a753, #b18b45);
        }
        /* Toast */
        #toast-container {
            position: fixed; bottom: 20px; right: 20px; z-index: 60; pointer-events: none;
        }
        .toast {
            background-color: rgba(0, 0, 0, 0.8); color: white; padding: 10px 20px;
            border-radius: 25px; margin-bottom: 10px; opacity: 0;
            transition: opacity 0.3s; transform: translateY(20px);
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        
        .loading-overlay {
            position: absolute; inset: 0; background: rgba(255,255,255,0.8);
            display: flex; justify-content: center; align-items: center; z-index: 10;
        }
        
        @media (max-width: 768px) {
             #toast-container { bottom: 80px; left: 50%; transform: translateX(-50%); right: auto; }
             .mobile-filters-hidden { display: none !important; }
             .mobile-nav { position: fixed; bottom: 0; left: 0; width: 100%; z-index: 50; }
        }
        @media (min-width: 769px) { .mobile-nav { display: none; } }
        @media print { .no-print { display: none !important; } body { background-color: #fff !important; } }
    </style>
</head>
<body class="text-stone-800">

    <header class="bg-white shadow-lg sticky top-0 z-10 no-print">
        <div class="container mx-auto px-4 py-2 flex flex-col items-center">
            <span style="font-family: serif; font-size: 2.25rem; font-weight: 800; color: #1c1917; line-height: 1;">blanco&madera</span>
            <hr class="w-24 border-stone-400 my-0.5">
            <span style="font-size: 0.75rem; letter-spacing: 0.3em; color: #78716c;">SISTEMA VENDEDOR</span>
        </div>
    </header>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8 pt-0"> 
        <div class="py-4 text-center">
            <h1 class="text-4xl font-extrabold text-amber-800">PANEL DE VENTAS</h1>
            <div id="connection-status" class="text-xs text-stone-400 mt-1">Conectando...</div>
        </div>
        
        <div id="toast-container"></div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- PANEL IZQUIERDO: LISTADO -->
            <div class="space-y-6">
                <div id="catalog-panel" class="bg-white p-6 rounded-xl shadow-lg relative min-h-[400px]">
                    <h2 class="text-xl font-semibold mb-4 text-amber-800 border-b pb-2 border-stone-200">Stock Disponible</h2>
                    
                    <!-- FILTROS -->
                    <div class="bg-white rounded-xl mb-4 no-print border-b pb-4 border-stone-100">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div>
                                <label class="block text-sm font-semibold text-stone-700 mb-1">Categor√≠a</label>
                                <select id="category-filter" class="w-full rounded-lg border-stone-300 shadow-sm p-2"><option value="all">Todas</option></select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-stone-700 mb-1">Buscar</label>
                                <input type="text" id="search-box" placeholder="Nombre..." class="w-full rounded-lg border-stone-300 shadow-sm p-2">
                            </div>
                            <div class="md:self-end">
                                <button id="reset-button" class="w-full bg-stone-500 text-white font-bold py-2.5 rounded-lg hover:bg-stone-600">Mostrar Todos</button>
                            </div>
                        </div>
                    </div>

                    <div id="catalog-loading" class="loading-overlay">
                        <div class="text-amber-600 font-bold animate-pulse">Cargando productos...</div>
                    </div>
                    
                    <div id="product-list" class="overflow-y-auto h-[60vh] md:h-[70vh] pr-4 space-y-2"></div>
                </div>

                <!-- PANEL GESTION -->
                <div class="bg-white p-6 rounded-xl shadow-lg no-print">
                    <h2 class="text-xl font-semibold mb-4 text-stone-700 border-b pb-2">Herramientas de Gesti√≥n</h2>
                    <div class="flex flex-col space-y-3">
                        <button id="download-sales-report-button" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow-md hover:bg-blue-700">‚¨áÔ∏è Descargar Historial de Ventas</button>
                        <button onclick="openManualSaleModal()" class="w-full bg-red-500 text-white font-bold py-3 rounded-lg shadow-md hover:bg-red-600">‚ûï Registrar Venta Manual</button>
                        
                        <!-- BOT√ìN DE RECUPERACI√ìN DE STOCK -->
                        <button onclick="restoreStockFromSales()" class="w-full bg-amber-500 text-white font-bold py-3 rounded-lg shadow-md hover:bg-amber-600 border-2 border-amber-600 mt-4">
                             üõ†Ô∏è Recalcular Stock (Inicial - Ventas Hist√≥ricas)
                        </button>
                        <p class="text-xs text-stone-500 text-center">Usar este bot√≥n SOLO si el stock se reinici√≥. Restar√° todas las ventas hist√≥ricas al stock actual.</p>
                    </div>
                </div>
            </div>
            
            <!-- PANEL DERECHO: CARRITO -->
            <div id="cart-panel" class="hidden md:flex flex-col bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold mb-4 text-amber-800 border-b pb-2 border-stone-200">Cotizaci√≥n</h2>
                <div class="mb-4 no-print"><input type="text" id="client-name" placeholder="Cliente" class="w-full rounded-lg border-stone-300 p-2 shadow-sm"></div>
                <div class="mb-4 no-print"><input type="tel" id="whatsapp-number" placeholder="WhatsApp (549...)" class="w-full rounded-lg border-stone-300 p-2 shadow-sm"></div>
                <div class="mb-4 no-print"><select id="payment-method" class="w-full rounded-lg border-stone-300 p-2 shadow-sm"><option value="Efectivo">Efectivo</option><option value="Transferencia">Transferencia</option><option value="Tarjeta">Tarjeta</option><option value="Otro">Otro</option></select></div>
                
                <!-- CORRECCI√ìN APLICADA: empty-cart-message movido fuera de cart-list para evitar borrado accidental -->
                <div class="flex-grow relative">
                    <div id="cart-list" class="absolute inset-0 overflow-y-auto pr-4 space-y-2"></div>
                    <p id="empty-cart-message" class="text-stone-500 text-center mt-8 pointer-events-none">Carrito vac√≠o.</p>
                </div>

                <div class="mt-4 pt-4 border-t-2 border-amber-500/50">
                    <div class="mb-4 no-print"><label class="block text-sm font-bold mb-1">Descuento:</label><select id="discount-select" class="w-full rounded-lg border-stone-300 p-2"><option value="0">0%</option><option value="0.05">5%</option><option value="0.10">10%</option><option value="0.15">15%</option><option value="0.20">20%</option></select></div>
                    <div class="flex justify-between items-center mb-4"><span class="text-2xl font-bold">TOTAL:</span><span id="cart-total" class="text-4xl font-extrabold text-amber-800">$0</span></div>
                    <div class="space-y-3 no-print">
                        <button id="save-pending-button" class="w-full bg-stone-700 text-white font-bold py-3 rounded-lg shadow-xl hover:bg-stone-800">üíæ Guardar Pendiente</button>
                        <button id="confirm-sale-button" class="w-full bg-red-700 text-white font-bold py-3 rounded-lg shadow-xl hover:bg-red-800">‚ùå Registrar Venta</button>
                        <div class="grid grid-cols-2 gap-3 mt-2"><button id="send-whatsapp-text-button" class="bg-green-600 text-white font-bold py-2 rounded-lg shadow-md">üí¨ WhatsApp</button><button id="share-image-button" class="bg-amber-500 text-white font-bold py-2 rounded-lg shadow-md">üñºÔ∏è Imagen</button></div>
                        <div class="grid grid-cols-2 gap-3 mt-2"><button id="print-button" class="bg-stone-500 text-white font-bold py-2 rounded-lg shadow-md">üñ®Ô∏è Imprimir</button><button id="clear-cart-button" class="bg-red-500/50 text-white font-bold py-2 rounded-lg shadow-md">üóëÔ∏è Vaciar</button></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- PEDIDOS PENDIENTES -->
        <div class="bg-white p-6 rounded-xl shadow-lg no-print mt-6">
            <h2 class="text-xl font-semibold mb-4 text-amber-800 border-b pb-2">‚è≥ Pedidos Pendientes</h2>
            <div id="pending-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
        </div>
    </main>

    <!-- MODAL VISTA R√ÅPIDA -->
    <div id="product-quickview-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-xl mx-4 relative">
            <button onclick="closeProductModal()" class="absolute top-4 right-4 text-stone-500 hover:text-red-600 text-3xl">&times;</button>
            <h3 id="modal-product-name" class="text-2xl font-bold text-amber-800 pr-8 mb-4"></h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-stone-100 rounded-lg flex items-center justify-center p-2 h-[300px]"><img id="modal-product-image" src="" class="max-h-full max-w-full object-contain shadow-sm"></div>
                <div class="flex flex-col justify-center">
                    <p class="text-sm font-semibold text-stone-500">Categor√≠a:</p><p id="modal-product-category" class="text-lg font-medium text-stone-800 mb-4"></p>
                    <p class="text-sm font-semibold text-stone-500">Precio:</p><p id="modal-product-price" class="text-3xl font-extrabold text-amber-800 mb-4"></p>
                    <p id="modal-product-stock" class="text-lg font-bold text-stone-700 mb-6"></p>
                    <button id="modal-add-to-cart-button" class="w-full amber-gradient text-white font-bold py-3 rounded-lg shadow-lg hover:opacity-90">üõí Agregar a Cotizaci√≥n</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL VENTA MANUAL -->
    <div id="manual-sale-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md mx-4">
            <h3 class="text-xl font-bold mb-4 text-red-700 border-b pb-2">‚ûï Venta Manual</h3>
            <div class="space-y-4">
                <input type="text" id="manual-sale-product-name" placeholder="Producto" class="w-full border p-2 rounded">
                <div class="grid grid-cols-2 gap-2"><input type="number" id="manual-sale-quantity" value="1" class="w-full border p-2 rounded"><input type="number" id="manual-sale-price" placeholder="Precio" class="w-full border p-2 rounded"></div>
                <input type="text" id="manual-sale-client-name" value="Venta Externa" class="w-full border p-2 rounded">
                <select id="manual-sale-payment" class="w-full border p-2 rounded"><option value="Efectivo">Efectivo</option><option value="Transferencia">Transferencia</option><option value="Tarjeta">Tarjeta</option><option value="Otro">Otro</option></select>
                <div class="flex items-center"><input type="checkbox" id="manual-sale-deduct-stock" checked class="mr-2"> <label>Descontar Stock</label></div>
                <div class="flex gap-2"><button onclick="closeManualSaleModal()" class="flex-1 bg-gray-300 py-2 rounded font-bold">Cancelar</button><button onclick="handleManualSale()" class="flex-1 bg-red-600 text-white py-2 rounded font-bold">Registrar</button></div>
            </div>
        </div>
    </div>

    <!-- NAV M√ìVIL -->
    <div class="mobile-nav bg-white shadow-2xl p-3 border-t border-stone-200 flex justify-around">
        <button onclick="showView('catalog')" class="flex flex-col items-center text-amber-800 font-bold"><span class="text-2xl">üõí</span><span class="text-xs">Cat√°logo</span></button>
        <button onclick="showView('cart')" class="flex flex-col items-center text-stone-500 font-bold"><span class="text-2xl">üìù</span><span class="text-xs">Cotizaci√≥n</span></button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, onSnapshot, addDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "", 
            authDomain: "blanco-y-madera-17214.firebaseapp.com",
            projectId: "blanco-y-madera-17214",
            storageBucket: "blanco-y-madera-17214.appspot.com",
            messagingSenderId: "147976695842",
            appId: "1:147976695842:web:e165092b1fee5aa1e99a7b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let productData = [];
        let cart = {};
        let categories = new Set();
        const STORAGE_KEY = 'bm_cart_v2';

        // --- FUNCIONES GLOBALES ---
        
        // Descargar Ventas (RESTAURADO)
        window.downloadSalesReport = async function() {
            showToast("Generando reporte...");
            try {
                const salesSnapshot = await getDocs(collection(db, "ventas"));
                let csvContent = "data:text/csv;charset=utf-8,";
                // BOM para Excel
                csvContent += "\uFEFF"; 
                csvContent += "Fecha;Cliente;WhatsApp;Pago;Total;Descuento;Items\n";
                
                salesSnapshot.forEach((doc) => {
                    const s = doc.data();
                    // Formatear items
                    let itemsStr = "";
                    if (s.items && Array.isArray(s.items)) {
                        itemsStr = s.items.map(i => `${i.nombre} (x${i.cantidad})`).join(" | ");
                    }
                    
                    const row = [
                        s.fecha_venta || s.fecha || "-",
                        `"${s.cliente_nombre || s.cliente || "-"}"`,
                        s.cliente_whatsapp || "-",
                        s.metodo_pago || s.pago || "-",
                        s.total_final || s.total || 0,
                        s.descuento_aplicado || 0,
                        `"${itemsStr}"`
                    ];
                    csvContent += row.join(";") + "\n";
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `Ventas_${new Date().toLocaleDateString().replace(/\//g,'-')}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showToast("Reporte descargado");
            } catch (e) {
                console.error(e);
                alert("Error al descargar reporte: " + e.message);
            }
        };

        window.editStock = async function(id, current) {
            const newVal = prompt(`Editar Stock para este producto:\nActual: ${current}`, current);
            if (newVal !== null && !isNaN(newVal)) {
                const stockNum = parseInt(newVal);
                if (stockNum >= 0) {
                    await updateDoc(doc(db, "products", id), { stock: stockNum });
                    showToast("Stock actualizado ‚úÖ");
                }
            }
        };

        // FUNCION RESTAURAR STOCK
        window.restoreStockFromSales = async function() {
            if (!confirm("‚ö†Ô∏è ATENCI√ìN: Esta funci√≥n calcular√° el stock restando TODAS las ventas hist√≥ricas al stock que figura actualmente.\n\n¬øEst√°s seguro de que el stock actual es el INICIAL/DEFAULT y quieres restarle las ventas?")) {
                return;
            }

            showToast("‚è≥ Analizando historial de ventas... Espere.");
            
            try {
                // 1. Obtener todas las ventas
                const salesSnapshot = await getDocs(collection(db, "ventas"));
                const salesMap = {}; // Mapa: "Nombre Producto" -> Cantidad Total Vendida

                salesSnapshot.forEach(doc => {
                    const sale = doc.data();
                    if (sale.items && Array.isArray(sale.items)) {
                        sale.items.forEach(item => {
                            const name = item.nombre.trim(); // Normalizar nombre
                            if (!salesMap[name]) salesMap[name] = 0;
                            salesMap[name] += item.cantidad;
                        });
                    }
                });

                // 2. Recorrer productos y actualizar
                const batch = writeBatch(db);
                let updatesCount = 0;
                let logMsg = "Resumen de Ajustes:\n";

                productData.forEach(product => {
                    const soldQty = salesMap[product.nombre.trim()] || 0;
                    if (soldQty > 0) {
                        // Stock Nuevo = Stock Actual (que es el inicial tras el reseteo) - Vendido
                        const newStock = product.stock - soldQty;
                        const ref = doc(db, "products", product.id);
                        
                        // Solo actualizar si el n√∫mero cambia (aunque tras el reset, cambiar√° seguro)
                        batch.update(ref, { stock: newStock });
                        updatesCount++;
                        logMsg += `- ${product.nombre}: ${product.stock} -> ${newStock} (Ventas: ${soldQty})\n`;
                    }
                });

                if (updatesCount > 0) {
                    await batch.commit();
                    alert(`‚úÖ Se actualizaron ${updatesCount} productos correctamente.\n\n${logMsg}`);
                    showToast("Stock restaurado con √©xito.");
                } else {
                    alert("No se encontraron ventas que afecten al stock actual o los nombres no coinciden.");
                }

            } catch (e) {
                console.error(e);
                alert("Error al restaurar stock: " + e.message);
            }
        };

        window.openQuickView = function(id) {
            const product = productData.find(p => p.id === id);
            if (!product) return;
            const modal = document.getElementById('product-quickview-modal');
            document.getElementById('modal-product-name').textContent = product.nombre;
            document.getElementById('modal-product-category').textContent = product.categoria;
            document.getElementById('modal-product-price').textContent = formatCurrency(product.precio);
            document.getElementById('modal-product-image').src = product.imageUrl || product.ImageUrl || "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjY2NjIiBzdHJva2Utd2lkdGg9IjEiPjxyZWN0IHg9IjMiIHk9IjMiIHdpZHRoPSIxOCIgaGVpZ2h0PSIxOCIgcng9IjIiLz48L3N2Zz4=";
            
            const stockEl = document.getElementById('modal-product-stock');
            const addBtn = document.getElementById('modal-add-to-cart-button');
            
            if (product.stock <= 0) {
                stockEl.innerHTML = '<span class="text-red-600">‚ùå Sin Stock</span>';
                addBtn.disabled = true; addBtn.classList.add('opacity-50');
            } else {
                stockEl.innerHTML = `<span class="text-green-600">‚úÖ ${product.stock} unidades</span>`;
                addBtn.disabled = false; addBtn.classList.remove('opacity-50');
            }
            addBtn.onclick = () => { addToCart(id); closeProductModal(); };
            modal.style.display = 'flex';
        };

        window.closeProductModal = () => document.getElementById('product-quickview-modal').style.display = 'none';
        window.openManualSaleModal = () => document.getElementById('manual-sale-modal').style.display = 'flex';
        window.closeManualSaleModal = () => document.getElementById('manual-sale-modal').style.display = 'none';

        window.addToCart = function(id) {
            const product = productData.find(p => p.id === id);
            if (!product) return;
            if (!cart[id]) cart[id] = { ...product, cantidad: 0 };
            if (cart[id].cantidad + 1 > product.stock) return showToast(`‚ö†Ô∏è Stock m√°ximo alcanzado`);
            cart[id].cantidad++; saveCart(); renderCart(); showToast(`üõí ${product.nombre} agregado`);
        };

        window.changeQuantity = function(id, delta) {
            if (!cart[id]) return;
            const newQty = cart[id].cantidad + delta;
            const product = productData.find(p => p.id === id);
            if (newQty > product.stock) return showToast(`‚ö†Ô∏è No hay m√°s stock`);
            if (newQty <= 0) delete cart[id]; else cart[id].cantidad = newQty;
            saveCart(); renderCart();
        };

        function renderProductList(data) {
            const list = document.getElementById('product-list');
            list.innerHTML = '';
            if (data.length === 0) return list.innerHTML = '<p class="text-center text-stone-500">Sin resultados.</p>';
            data.forEach(p => {
                const item = document.createElement('div');
                const isNoStock = p.stock <= 0;
                const opacity = isNoStock ? 'opacity-60' : '';
                const imgUrl = p.imageUrl || p.ImageUrl;
                const imgHtml = imgUrl ? `<img src="${imgUrl}" class="w-12 h-12 rounded object-cover bg-stone-200">` : `<div class="w-12 h-12 rounded bg-stone-200 flex items-center justify-center text-xl">üñºÔ∏è</div>`;
                const stockBadge = p.stock > 3 ? 'bg-green-100 text-green-800' : (p.stock > 0 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-400 text-white');

                item.className = `bg-white p-3 rounded-xl border border-stone-100 flex justify-between items-center item-card ${opacity}`;
                item.onclick = (e) => { if(!e.target.closest('button')) openQuickView(p.id); };
                item.innerHTML = `
                    <div class="flex items-center gap-3 flex-grow">
                        ${imgHtml}
                        <div><p class="font-bold text-stone-800 leading-tight">${p.nombre}</p>
                        <div class="flex gap-2 items-center mt-1"><span class="text-xs bg-stone-100 px-2 rounded text-stone-600">${p.categoria}</span>
                        <div class="flex items-center gap-1 ${stockBadge} px-2 py-0.5 rounded-full"><span class="text-xs font-bold">${p.stock>0?`Stock: ${p.stock}`:'Sin Stock'}</span><button class="stock-edit-btn ml-1 text-xs hover:bg-white/20 rounded px-1" onclick="event.stopPropagation(); editStock('${p.id}', ${p.stock})">‚úèÔ∏è</button></div></div></div>
                    </div>
                    <div class="flex items-center gap-3 pl-2"><span class="font-extrabold text-amber-800">${formatCurrency(p.precio)}</span><button class="cart-btn p-2 rounded-lg shadow-md text-white ${isNoStock?'bg-stone-400':'amber-gradient hover:opacity-90'}" ${isNoStock?'disabled':''} onclick="addToCart('${p.id}')">üõí</button></div>
                `;
                list.appendChild(item);
            });
        }

        const q = collection(db, "products");
        onSnapshot(q, (snapshot) => {
            productData = []; categories = new Set();
            snapshot.forEach(doc => {
                const d = doc.data(); d.id = doc.id; productData.push(d);
                if(d.categoria) categories.add(d.categoria);
            });
            document.getElementById('catalog-loading').style.display = 'none';
            document.getElementById('connection-status').textContent = "üü¢ Conectado";
            document.getElementById('connection-status').classList.add('text-green-600');
            const catSelect = document.getElementById('category-filter');
            const current = catSelect.value;
            catSelect.innerHTML = '<option value="all">Todas</option>';
            Array.from(categories).sort().forEach(c => catSelect.innerHTML += `<option value="${c}">${c}</option>`);
            catSelect.value = current;
            updateDashboard();
        });

        function updateDashboard() {
            const cat = document.getElementById('category-filter').value;
            const search = document.getElementById('search-box').value.toLowerCase();
            const filtered = productData.filter(p => (cat === 'all' || p.categoria === cat) && (p.nombre||'').toLowerCase().includes(search));
            renderProductList(filtered); renderCart();
        }

        function renderCart() {
            const list = document.getElementById('cart-list'); list.innerHTML = ''; 
            let subtotal = 0, count = 0;
            for(const id in cart) {
                const item = cart[id];
                subtotal += item.precio * item.cantidad; count += item.cantidad;
                list.innerHTML += `<div class="bg-white p-2 rounded border flex justify-between items-center mb-2"><div><div class="font-bold text-sm">${item.nombre}</div><div class="text-xs text-stone-500">$${item.precio} x ${item.cantidad}</div></div><div class="flex items-center gap-2"><span class="font-bold">$${item.precio*item.cantidad}</span><button onclick="changeQuantity('${id}', -1)" class="px-2 bg-stone-200 rounded">-</button><button onclick="changeQuantity('${id}', 1)" class="px-2 bg-amber-500 text-white rounded">+</button></div></div>`;
            }
            const disc = parseFloat(document.getElementById('discount-select').value);
            document.getElementById('cart-total').textContent = formatCurrency(subtotal * (1-disc));
            
            // CORRECCI√ìN DEL ERROR: Actualizaci√≥n segura de visibilidad
            const emptyEl = document.getElementById('empty-cart-message');
            if (emptyEl) emptyEl.style.display = count ? 'none' : 'block';
        }

        function formatCurrency(v) { return new Intl.NumberFormat('es-AR', {style:'currency', currency: 'ARS', minimumFractionDigits:0}).format(v); }
        function saveCart() { localStorage.setItem(STORAGE_KEY, JSON.stringify(cart)); }
        function loadCart() { const s = localStorage.getItem(STORAGE_KEY); if(s) cart = JSON.parse(s); renderCart(); }
        function showToast(msg) { const t = document.createElement('div'); t.className='toast show'; t.textContent=msg; document.getElementById('toast-container').appendChild(t); setTimeout(()=>t.remove(), 2000); }

        document.getElementById('category-filter').onchange = updateDashboard;
        document.getElementById('search-box').oninput = updateDashboard;
        document.getElementById('reset-button').onclick = () => { document.getElementById('category-filter').value='all'; document.getElementById('search-box').value=''; updateDashboard(); };
        document.getElementById('discount-select').onchange = renderCart;
        document.getElementById('clear-cart-button').onclick = () => { cart={}; saveCart(); renderCart(); };
        document.getElementById('print-button').onclick = () => window.print();
        document.getElementById('download-sales-report-button').onclick = window.downloadSalesReport;
        
        document.getElementById('send-whatsapp-text-button').onclick = () => {
            const name = document.getElementById('client-name').value || 'Cliente';
            let msg = `Hola ${name}, tu presupuesto:\n\n`;
            let tot = 0;
            for(let id in cart) { let i = cart[id]; msg += `‚Ä¢ ${i.nombre} x${i.cantidad}: $${i.precio*i.cantidad}\n`; tot += i.precio*i.cantidad; }
            const disc = parseFloat(document.getElementById('discount-select').value);
            if (disc > 0) msg += `\nDescuento: ${disc*100}%`;
            msg += `\n*TOTAL: ${formatCurrency(tot * (1-disc))}*\n\nTransferencias alias: *sofiricca*`;
            const num = document.getElementById('whatsapp-number').value.replace(/\D/g,'');
            window.open(`https://wa.me/${num}?text=${encodeURIComponent(msg)}`);
        };

        window.handleManualSale = async () => {
            const name = document.getElementById('manual-sale-product-name').value;
            const qty = parseInt(document.getElementById('manual-sale-quantity').value);
            const price = parseFloat(document.getElementById('manual-sale-price').value);
            const client = document.getElementById('manual-sale-client-name').value;
            const deduct = document.getElementById('manual-sale-deduct-stock').checked;
            const pay = document.getElementById('manual-sale-payment').value;

            if(!name || !qty || !price) return alert('Faltan datos');
            
            if(deduct) {
                const p = productData.find(x => x.nombre.toLowerCase() === name.toLowerCase());
                if(p) await updateDoc(doc(db, "products", p.id), {stock: p.stock - qty});
            }
            await addDoc(collection(db, "ventas"), { 
                fecha_venta: new Date().toLocaleDateString(), 
                cliente_nombre: client, 
                items: [{nombre: name, cantidad: qty, precio: price}], 
                total_final: price * qty,
                metodo_pago: pay
            });
            showToast("Venta registrada"); closeManualSaleModal();
        };
        
        document.getElementById('confirm-sale-button').onclick = async () => {
             if(Object.keys(cart).length === 0) return alert("Carrito vac√≠o");
             if(!confirm("Confirmar venta y descontar stock?")) return;
             
             const client = document.getElementById('client-name').value || 'Cliente';
             const whatsapp = document.getElementById('whatsapp-number').value;
             const pay = document.getElementById('payment-method').value;
             const disc = parseFloat(document.getElementById('discount-select').value);
             
             let total = 0;
             const items = [];
             const batch = writeBatch(db);
             
             for(let id in cart) {
                 const item = cart[id];
                 const p = productData.find(x => x.id === id);
                 if(p) {
                     const newStock = p.stock - item.cantidad;
                     if(newStock < 0) { alert(`No hay stock suficiente de ${p.nombre}`); return; }
                     batch.update(doc(db, "products", id), {stock: newStock});
                     items.push({nombre: item.nombre, cantidad: item.cantidad, precio_unitario: item.precio});
                     total += item.precio * item.cantidad;
                 }
             }
             
             await batch.commit();
             
             await addDoc(collection(db, "ventas"), {
                 fecha_venta: new Date().toLocaleDateString(),
                 cliente_nombre: client,
                 cliente_whatsapp: whatsapp,
                 metodo_pago: pay,
                 total_final: total * (1-disc),
                 descuento_aplicado: disc,
                 items: items
             });
             
             showToast("Venta exitosa!");
             cart = {}; saveCart(); renderCart();
        };

        const pendingList = document.getElementById('pending-list');
        onSnapshot(collection(db, "pending_orders"), (snap) => {
            pendingList.innerHTML = '';
            if(snap.empty) pendingList.innerHTML = '<p class="text-stone-500 text-center">Sin pendientes.</p>';
            snap.forEach(d => {
                const o = d.data();
                const div = document.createElement('div');
                div.className = 'bg-stone-50 p-2 border rounded mb-2 flex justify-between text-sm';
                div.innerHTML = `<span>${o.cliente_nombre} (${formatCurrency(o.total_estimado)})</span>`;
                const btn = document.createElement('button'); btn.className = 'text-blue-600 font-bold'; btn.textContent = 'Cargar';
                btn.onclick = () => { if(confirm('Cargar este pedido?')) { cart = o.cart; document.getElementById('client-name').value = o.cliente_nombre; saveCart(); renderCart(); } };
                const del = document.createElement('button'); del.className = 'text-red-600 ml-2'; del.textContent = 'üóëÔ∏è';
                del.onclick = () => deleteDoc(doc(db, "pending_orders", d.id));
                div.appendChild(btn); div.appendChild(del); pendingList.appendChild(div);
            });
        });

        document.getElementById('save-pending-button').onclick = async () => {
            if(Object.keys(cart).length === 0) return alert("Carrito vac√≠o");
            const client = document.getElementById('client-name').value || 'Sin nombre';
            const disc = parseFloat(document.getElementById('discount-select').value);
            let total = 0; for(let k in cart) total += cart[k].precio * cart[k].cantidad;
            await addDoc(collection(db, "pending_orders"), { timestamp: new Date(), cliente_nombre: client, cart: cart, total_estimado: total * (1-disc) });
            showToast("Guardado en pendientes"); cart = {}; saveCart(); renderCart();
        };

        window.showView = (v) => { const isCat = v === 'catalog'; document.getElementById('catalog-panel').style.display = isCat ? 'block' : 'none'; document.getElementById('cart-panel').style.display = isCat ? 'none' : 'flex'; };
        loadCart();
    </script>
</body>
</html>
