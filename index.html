<!DOCTYPE html>
<html lang="es">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat√°logo Blanco & Madera</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fefce8; /* Fondo suave (Amber 50) */
        }
        .item-card { transition: background-color 0.1s; }
        .item-card:hover { background-color: #fffbeb; }
        .logo-text {
            font-family: serif; font-size: 1.5rem; font-weight: 800; color: #1c1917; line-height: 1;
        }
        .deco-home { font-size: 0.6rem; letter-spacing: 0.2em; color: #78716c; display: block; }
        
        /* Scrollbars finas */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #d4a753; border-radius: 10px; }

        .mobile-nav { position: fixed; bottom: 0; left: 0; width: 100%; z-index: 50; }
        @media (min-width: 768px) { .mobile-nav { display: none; } }
        
        #toast-container {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            z-index: 60; pointer-events: none; width: 90%; max-width: 400px;
        }
        .toast {
            background-color: rgba(0, 0, 0, 0.85); color: white; padding: 8px 16px;
            border-radius: 8px; margin-bottom: 8px; opacity: 0;
            transition: opacity 0.3s, transform 0.3s; transform: translateY(10px);
            text-align: center; font-size: 0.85rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .toast.show { opacity: 1; transform: translateY(0); }

        .modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto;
            background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: #fff; margin: auto; padding: 15px;
            border-radius: 10px; width: 95%; max-width: 450px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .modal.show { display: flex; }

        @media print {
            .no-print { display: none !important; }
            #print-view { display: block !important; }
            body { background-color: #fff; }
        }
    </style>
</head>
<body class="text-stone-800 pb-16 md:pb-0 h-screen flex flex-col">

    <!-- HEADER ULTRA COMPACTO -->
    <header class="bg-white shadow-sm sticky top-0 z-20 no-print flex-none">
        <div class="container mx-auto px-2 py-1 flex justify-between items-center">
            <div class="flex items-center gap-2 cursor-pointer" onclick="window.scrollTo(0,0)">
                <div>
                    <span class="logo-text leading-none">blanco&madera</span>
                    <span class="deco-home leading-none text-left">DECO HOME</span>
                </div>
            </div>
            <div class="text-right">
                <div id="connection-status" class="text-[10px] text-stone-400 font-medium">Conectando...</div>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-2 flex-grow flex flex-col overflow-hidden"> 
        
        <!-- FILTROS ULTRA COMPACTOS (Todo en una l√≠nea) -->
        <div class="bg-white p-2 rounded-lg shadow-sm mb-2 border border-stone-100 no-print flex-none" id="filters-container">
            <div class="flex gap-2">
                <!-- Buscador -->
                <div class="flex-grow relative">
                    <input type="text" id="search-box" placeholder="üîç Buscar producto..." class="w-full rounded border-stone-300 bg-stone-50 text-sm py-1.5 pl-2 pr-2 focus:border-amber-500 focus:ring-1 focus:ring-amber-500">
                </div>
                
                <!-- Categor√≠a -->
                <div class="w-1/3 md:w-1/4">
                    <select id="category-filter" class="w-full rounded border-stone-300 bg-stone-50 text-sm py-1.5 px-1 focus:border-amber-500 focus:ring-1 focus:ring-amber-500 text-xs h-full font-medium text-stone-600">
                        <option value="all">üìÅ Todo</option>
                    </select>
                </div>

                <!-- Reset -->
                <button id="reset-button" class="bg-stone-200 text-stone-600 font-bold px-3 rounded text-xs hover:bg-stone-300 transition flex items-center justify-center">
                    ‚Ü∫
                </button>
            </div>
        </div>

        <div id="print-view" class="hidden print-header"></div>
        <div id="toast-container"></div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 h-full overflow-hidden">
            
            <!-- PANEL IZQUIERDO: LISTADO (Con scroll independiente) -->
            <div class="flex flex-col h-full overflow-hidden space-y-2">
                
                <!-- CAT√ÅLOGO -->
                <div id="catalog-panel" class="bg-white rounded-lg shadow border border-stone-200 flex flex-col flex-grow overflow-hidden" data-view="catalog">
                    <!-- Cabecera simple -->
                    <div class="flex justify-between items-center px-2 py-1 border-b border-stone-100 bg-stone-50/50 flex-none">
                        <h2 class="text-xs font-bold text-stone-600 uppercase tracking-wide">Cat√°logo</h2>
                        <span class="text-[10px] text-stone-400 font-mono" id="product-count">...</span>
                    </div>
                    
                    <div id="catalog-loading" class="absolute inset-0 flex justify-center items-center bg-white/80 z-10 hidden">
                        <div class="text-amber-600 font-bold animate-pulse text-sm">Cargando...</div>
                    </div>
                    
                    <!-- LISTA DE PRODUCTOS (Scroll aqu√≠) -->
                    <div id="product-list" class="overflow-y-auto p-1 space-y-1 flex-grow">
                        <!-- Items inyectados por JS -->
                    </div>
                </div>

                <!-- SECCI√ìN INFERIOR: PENDIENTES Y ACCIONES -->
                <div class="flex-none space-y-2 no-print overflow-y-auto max-h-[35vh]">
                    <!-- PEDIDOS PENDIENTES -->
                    <div class="bg-white px-2 py-1.5 rounded-lg shadow border border-stone-200">
                        <h2 class="text-xs font-bold mb-1 text-stone-600 border-b pb-0.5">‚è≥ Pedidos Guardados (Nube)</h2>
                        <div id="pending-list" class="space-y-1 max-h-32 overflow-y-auto">
                            <p id="pending-loading" class="text-stone-400 text-[10px]">Cargando...</p>
                        </div>
                    </div>
                    
                    <!-- ACCIONES R√ÅPIDAS -->
                    <div class="bg-white p-2 rounded-lg shadow border border-stone-200 grid grid-cols-2 gap-2">
                        <button id="download-sales-report-button" class="bg-blue-50 text-blue-700 font-semibold py-1.5 rounded text-[11px] hover:bg-blue-100 border border-blue-200 text-center">
                            üìä Reporte CSV
                        </button>
                        <button id="open-manual-sale-modal-btn" class="bg-red-50 text-red-700 font-semibold py-1.5 rounded text-[11px] hover:bg-red-100 border border-red-200 text-center">
                             ‚ûï Venta Manual
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- PANEL DERECHO: COTIZACI√ìN -->
            <div id="cart-panel" class="hidden md:flex flex-col bg-white p-2 rounded-lg shadow border border-stone-200 h-full overflow-hidden" data-view="cart">
                <h2 class="text-sm font-bold mb-2 text-amber-800 border-b pb-1 text-center bg-amber-50 rounded-t py-1">Cotizaci√≥n</h2>
                
                <!-- Datos Cliente -->
                <div class="flex-none space-y-1.5 mb-2 no-print">
                    <div class="flex gap-1">
                        <input type="text" id="client-name" placeholder="Nombre Cliente" class="w-1/2 rounded border-stone-300 text-xs py-1 px-2">
                        <input type="tel" id="whatsapp-number" placeholder="WhatsApp (549..)" class="w-1/2 rounded border-stone-300 text-xs py-1 px-2">
                    </div>
                    <div class="flex gap-1">
                        <select id="payment-method" class="w-1/2 rounded border-stone-300 text-xs py-1 px-2">
                            <option value="Efectivo">Efectivo</option>
                            <option value="Transferencia">Transferencia</option>
                            <option value="Tarjeta">Tarjeta</option>
                            <option value="Otro">Otro</option>
                        </select>
                        <select id="discount-select" class="w-1/2 rounded border-stone-300 text-xs py-1 px-2 text-red-600 font-medium">
                            <option value="0">Desc: 0%</option>
                            <option value="0.05">Desc: 5%</option>
                            <option value="0.10">Desc: 10%</option>
                            <option value="0.15">Desc: 15%</option>
                            <option value="0.20">Desc: 20%</option>
                        </select>
                    </div>
                </div>

                <div id="cart-list" class="overflow-y-auto flex-grow space-y-1 border rounded bg-stone-50 p-1 mb-2">
                    <p id="empty-cart-message" class="text-stone-400 text-center text-xs mt-4">Carrito vac√≠o.</p>
                </div>

                <!-- Totales -->
                <div class="flex-none pt-1 border-t border-dashed border-stone-300 bg-white">
                    <div id="discount-message-area" class="mb-0.5 text-center text-[10px] font-semibold text-red-600"></div>
                    <div class="flex justify-between items-center mb-2 px-2 bg-amber-50 rounded py-1">
                        <span class="text-sm font-bold text-stone-700">TOTAL:</span>
                        <span id="cart-total" class="text-xl font-extrabold text-amber-800">$0</span>
                    </div>

                    <!-- Botones -->
                    <div class="space-y-1.5 no-print">
                        <div class="grid grid-cols-2 gap-1.5">
                            <button id="save-pending-button" class="bg-stone-600 text-white font-bold py-1.5 rounded shadow text-xs hover:bg-stone-700">
                                üíæ Guardar
                            </button>
                            <button id="confirm-sale-button" class="bg-red-600 text-white font-bold py-1.5 rounded shadow text-xs hover:bg-red-700">
                                ‚ùå Vender (Stock)
                            </button>
                        </div>
                        <div class="grid grid-cols-3 gap-1">
                            <button id="send-whatsapp-text-button" class="bg-green-600 text-white font-bold py-1.5 rounded text-[10px] hover:bg-green-700 flex justify-center items-center">
                                üí¨ WhatsApp
                            </button>
                            <button id="share-image-button" class="bg-amber-500 text-white font-bold py-1.5 rounded text-[10px] hover:bg-amber-600 flex justify-center items-center">
                                üñºÔ∏è Imagen
                            </button>
                            <button id="clear-cart-button" class="bg-gray-400 text-white font-bold py-1.5 rounded text-[10px] hover:bg-gray-500 flex justify-center items-center">
                                üóëÔ∏è Vaciar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="text-center mt-2 no-print opacity-30 hover:opacity-100 transition-opacity flex-none">
            <button onclick="resetLocalData()" class="text-[9px] text-stone-400 underline">Restaurar DB (Emergencia)</button>
        </div>
    </main>

    <!-- MODAL VENTA MANUAL -->
    <div id="manual-sale-modal" class="modal">
        <div class="modal-content relative">
            <span id="close-manual-modal" class="absolute top-2 right-3 text-stone-400 text-xl cursor-pointer hover:text-stone-700 font-bold">&times;</span>
            <h2 class="text-lg font-bold text-amber-800 mb-3 border-b pb-1">Venta Manual</h2>
            <form id="manual-sale-form" class="space-y-3">
                <div>
                    <label class="block text-xs font-bold text-stone-600">Producto</label>
                    <select id="manual-product-select" class="w-full rounded border-stone-300 text-sm p-1.5 bg-stone-50">
                        <option value="">-- Seleccionar --</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-stone-600">Precio ($)</label>
                        <input type="number" id="manual-price" class="w-full rounded border-stone-300 p-1.5 text-sm" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-stone-600">Cant.</label>
                        <input type="number" id="manual-qty" value="1" min="1" class="w-full rounded border-stone-300 p-1.5 text-sm">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-stone-600">Cliente</label>
                    <input type="text" id="manual-client" class="w-full rounded border-stone-300 p-1.5 text-sm" placeholder="Ref. Cliente">
                </div>
                <div>
                    <label class="block text-xs font-bold text-stone-600">Pago</label>
                    <select id="manual-payment" class="w-full rounded border-stone-300 p-1.5 text-sm">
                        <option value="Efectivo">Efectivo</option>
                        <option value="Transferencia">Transferencia</option>
                        <option value="Tarjeta">Tarjeta</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                <div class="flex items-center gap-2 pt-2 border-t">
                    <input type="checkbox" id="manual-deduct-stock" class="w-4 h-4 text-amber-600 rounded">
                    <label for="manual-deduct-stock" class="text-xs font-bold text-stone-700">¬øDescontar Stock?</label>
                </div>

                <div class="pt-2 flex gap-2">
                    <button type="button" id="confirm-manual-sale" class="flex-1 bg-red-600 text-white py-2 rounded font-bold text-sm hover:bg-red-700">Confirmar</button>
                    <button type="button" id="cancel-manual-sale" class="flex-1 bg-gray-200 text-stone-700 py-2 rounded font-bold text-sm hover:bg-gray-300">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- NAV MOVIL -->
    <div class="mobile-nav bg-white shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] p-1 border-t border-stone-200 flex-none">
        <div class="flex justify-around items-center h-12">
            <button id="tab-catalog" onclick="showView('catalog')" class="flex flex-col items-center justify-center text-amber-800 font-bold focus:outline-none w-1/2 border-r border-stone-100 h-full">
                <span class="text-lg leading-none">üõí</span>
                <span class="text-[9px] mt-1">Cat√°logo</span>
            </button>
            <button id="tab-cart" onclick="showView('cart')" class="flex flex-col items-center justify-center text-stone-400 font-medium focus:outline-none w-1/2 relative h-full">
                <span class="text-lg leading-none">üìù</span>
                <span class="text-[9px] mt-1">Cotizaci√≥n</span>
                <span id="cart-item-count" class="absolute top-1 right-10 bg-red-500 text-white text-[8px] font-bold px-1.5 py-0.5 rounded-full opacity-0">0</span>
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, onSnapshot, setDoc, addDoc, writeBatch, deleteDoc, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // CONFIG FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyBeaZnBmmqd2kmgLjxaJvG33VYlAdKU5Y",
            authDomain: "blanco-y-madera-17214.firebaseapp.com",
            projectId: "blanco-y-madera-17214",
            storageBucket: "blanco-y-madera-17214.appspot.com",
            messagingSenderId: "147976695842",
            appId: "1:147976695842:web:e165092b1fee5aa1e99a7b",
            measurementId: "G-MHKJVMLRVL"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let productData = []; 
        let cart = {}; 
        let categories = new Set();
        const STORAGE_KEY_CART = 'bm_cart';
        
        // DATOS MAESTROS (Para reinicio)
        const rawData = [
            {"Product Name":"ALZAPA√ëOS","Price":"NaN", "Stock": "10"},
            {"Product Name":"Alzapa√±o Rosario","Price":"4800", "Stock": "4"},
            {"Product Name":"Alzapa√±o Tarragona","Price":"4800", "Stock": "4"},
            {"Product Name":"COLGANTES","Price":"NaN", "Stock": "10"},
            {"Product Name":"Colgante Grecia","Price":"4900", "Stock": "4"},
            {"Product Name":"Colgante Vibras","Price":"3700", "Stock": "4"},
            {"Product Name":"Colgante Creta","Price":"3600", "Stock": "8"},
            {"Product Name":"Colgante Coraz√≥n tela chico","Price":"4900", "Stock": "5"},
            {"Product Name":"Colgante Sue√±os Estrella","Price":"5400", "Stock": "3"},
            {"Product Name":"Colgante Sue√±os Luna","Price":"5400", "Stock": "0"},
            {"Product Name":"Colgante Tai","Price":"5300", "Stock": "2"},
            {"Product Name":"Colgante Macao","Price":"5300", "Stock": "4"},
            {"Product Name":"Colgante Sue√±os Coraz√≥n","Price":"5400", "Stock": "1"},
            {"Product Name":"TEXTILES MESA","Price":"NaN", "Stock": "10"},
            {"Product Name":"Camino De Arpillera","Price":"11600", "Stock": "2"},
            {"Product Name":"Camino De Mesa Albania","Price":"9300", "Stock": "1"},
            {"Product Name":"Camino De Mesa Betina Canela","Price":"13100", "Stock": "2"},
            {"Product Name":"Camino De Mesa Betina Rosado","Price":"13100", "Stock": "1"},
            {"Product Name":"Camino De Mesa Betina Vis√≥n","Price":"13100", "Stock": "0"}, 
            {"Product Name":"Camino De Mesa Betina Verde seco","Price":"13100", "Stock": "3"},
            {"Product Name":"Camino De Mesa Betina Blanco tiza","Price":"13100", "Stock": "3"},
            {"Product Name":"Camino De Mesa Gasa Natural","Price":"12200", "Stock": "1"},
            {"Product Name":"Camino De Mesa Gasa Ocre","Price":"12200", "Stock": "1"},
            {"Product Name":"Camino De Mesa Gasa Gris elefante","Price":"12200", "Stock": "2"},
            {"Product Name":"Individual Caterina","Price":"5800", "Stock": "0"},
            {"Product Name":"Individual De Tussor","Price":"5100", "Stock": "3"},
            {"Product Name":"Individual Siena","Price":"5400", "Stock": "0"},
            {"Product Name":"Mantel Matero M√≥naco","Price":"5900", "Stock": "2"},
            {"Product Name":"Repasador Patagonia","Price":"4300", "Stock": "0"},
            {"Product Name":"Set De Repasarores Marr√≥n","Price":"10700", "Stock": "0"},
            {"Product Name":"Set De Repasarores Ladrillo","Price":"10700", "Stock": "1"},
            {"Product Name":"Set De Repasarores Lila","Price":"10700", "Stock": "1"},
            {"Product Name":"Set De Repasarores Verde seco","Price":"10700", "Stock": "0"},
            {"Product Name":"Set Servilletas Tussor X4 Beige","Price":"9200", "Stock": "4"},
            {"Product Name":"Set Servilletas Tussor X4 Vis√≥n","Price":"9200", "Stock": "2"},
            {"Product Name":"Set Servilletas Tussor X4 Blanco","Price":"9200", "Stock": "3"},
            {"Product Name":"Set Servilletas Tussor X4 Gris oscuro","Price":"9200", "Stock": "2"},
            {"Product Name":"CONTENEDORES","Price":"NaN", "Stock": "10"},
            {"Product Name":"Contenedor Rayas Beige","Price":"6500", "Stock": "2"},
            {"Product Name":"Contenedor Rayas Gris","Price":"6500", "Stock": "2"},
            {"Product Name":"Funda Para Burlete Natural","Price":"4200", "Stock": "2"},
            {"Product Name":"Funda Para Burlete Jean","Price":"4200", "Stock": "2"},
            {"Product Name":"Manta Alfombra Grande (Natural rayas grises)","Price":"34900", "Stock": "1"},
            {"Product Name":"Manta Alfombra Grande (Natural rayas negras)","Price":"34900", "Stock": "1"},
            {"Product Name":"Manta Alfombra Grande (Natural rayas beige)","Price":"34900", "Stock": "0"},
            {"Product Name":"Manta Alfombra Grande (Gris rayas naturales)","Price":"34900", "Stock": "1"},
            {"Product Name":"Manta Alfombra Grande (Natural lisa)","Price":"34900", "Stock": "1"},
            {"Product Name":"Set De Limpieza Facial Beige","Price":"6800", "Stock": "1"},
            {"Product Name":"Set De Limpieza Facial Gris","Price":"6800", "Stock": "1"},
            {"Product Name":"BANDEJAS","Price":"NaN", "Stock": "10"},
            {"Product Name":"Bandeja Indonesia (25 cm) Pino","Price":"8200", "Stock": "1"},
            {"Product Name":"Bandeja Nepal (15X25 cm) pino","Price":"6100", "Stock": "3"},
            {"Product Name":"Bandeja Nepal (10X30 cm) pino","Price":"5400", "Stock": "3"},
            {"Product Name":"Bandeja Minka Chica (18x10 cm) Yeso","Price":"4400", "Stock": "5"},
            {"Product Name":"Bandeja Minka Grande (23x11.5 cm) Yeso","Price":"5400", "Stock": "3"},
            {"Product Name":"Bandeja Baru (10x10 cm) Yeso","Price":"3000", "Stock": "4"},
            {"Product Name":"Bandeja Jeric√≥ (18 cm) Yeso","Price":"5400", "Stock": "1"},
            {"Product Name":"Bandeja Patricia (25 cm) Melamina","Price":"5900", "Stock": "5"},
            {"Product Name":"Bandeja Giuliana (30x12 cm) Melamina","Price":"4100", "Stock": "4"},
            {"Product Name":"Bandeja Teresa (30x12 cm) Melamina","Price":"4100", "Stock": "6"},
            {"Product Name":"Bandeja In√©s (20x10 cm) Melamina","Price":"3400", "Stock": "1"},
            {"Product Name":"Bandeja Paris set","Price":"10300", "Stock": "1"},
            {"Product Name":"DECO MADERA","Price":"NaN", "Stock": "10"},
            {"Product Name":"Palabra Corporea Chica Amor","Price":"4600", "Stock": "0"},
            {"Product Name":"Palabra Corporea Chica Relax","Price":"4600", "Stock": "2"},
            {"Product Name":"Palabra Corporea Chica Love","Price":"4600", "Stock": "0"},
            {"Product Name":"Palabra Corporea Chica Smiles","Price":"4600", "Stock": "1"},
            {"Product Name":"Palabra Corporea Chica Calma","Price":"4600", "Stock": "0"},
            {"Product Name":"Palabra Corporea Mediana Sonr√≠e","Price":"4600", "Stock": "0"},
            {"Product Name":"Palabra Corporea Mediana Hola!","Price":"4600", "Stock": "2"},
            {"Product Name":"Palabra Corporea Mediana Home","Price":"4600", "Stock": "2"},
            {"Product Name":"Palabra Corporea Grande Familia","Price":"6200", "Stock": "1"},
            {"Product Name":"Palabra Corporea Vertical Love","Price":"5800", "Stock": "0"},
            {"Product Name":"Palabra Corporea Vertical Home","Price":"5800", "Stock": "0"},
            {"Product Name":"Posa Vela Berlin (Set x2)","Price":"5300", "Stock": "1"},
            {"Product Name":"Posa Vela Monstera","Price":"2900", "Stock": "1"},
            {"Product Name":"PORTASAHUMERIOS","Price":"NaN", "Stock": "10"},
            {"Product Name":"Portasahumerio Camila Corazon","Price":"2600", "Stock": "2"},
            {"Product Name":"Portasahumerio Camila Estrella","Price":"2600", "Stock": "2"},
            {"Product Name":"Portasahumerio Camila Redondo","Price":"2600", "Stock": "1"},
            {"Product Name":"Portasahumerio Loto 10x10","Price":"3300", "Stock": "2"},
            {"Product Name":"Portasahumerio Karen 19 cm","Price":"4200", "Stock": "1"},
            {"Product Name":"Portasahumerio Arco Iris 18 cm","Price":"4400", "Stock": "1"},
            {"Product Name":"Portasahumerio Hamsa 15x11cm","Price":"5800", "Stock": "2"},
            {"Product Name":"Portasahumerio Sky","Price":"1500", "Stock": "10"},
            {"Product Name":"VELAS","Price":"NaN", "Stock": "10"},
            {"Product Name":"Vela Francisca limon","Price":"5600", "Stock": "2"},
            {"Product Name":"Vela Francisca lavanda","Price":"5600", "Stock": "0"},
            {"Product Name":"Vela Francisca vainilla","Price":"5600", "Stock": "0"},
            {"Product Name":"Vela Francisca floral","Price":"5600", "Stock": "1"},
            {"Product Name":"Vela Olivia limon","Price":"4700", "Stock": "0"},
            {"Product Name":"Vela Olivia lavanda","Price":"4700", "Stock": "2"},
            {"Product Name":"Vela Olivia vainilla","Price":"4700", "Stock": "0"},
            {"Product Name":"Vela Olivia floral","Price":"4700", "Stock": "1"},
            {"Product Name":"Vela Niza 9cm limon","Price":"4500", "Stock": "0"},
            {"Product Name":"Vela Niza 9cm lavanda","Price":"4500", "Stock": "2"},
            {"Product Name":"Vela Niza 9cm vainilla","Price":"4500", "Stock": "0"},
            {"Product Name":"Vela Niza 9cm floral","Price":"4500", "Stock": "1"},
            {"Product Name":"Vela Venecia limon","Price":"10000", "Stock": "1"},
            {"Product Name":"Vela Venecia lavanda","Price":"10000", "Stock": "0"},
            {"Product Name":"Vela Venecia vainilla","Price":"10000", "Stock": "0"},
            {"Product Name":"Vela Venecia floral","Price":"10000", "Stock": "2"},
            {"Product Name":"Vela Marsella limon","Price":"6200", "Stock": "0"},
            {"Product Name":"Vela Marsella lavanda","Price":"6200", "Stock": "0"},
            {"Product Name":"Vela Marsella vainilla","Price":"6200", "Stock": "0"},
            {"Product Name":"Vela Marsella floral","Price":"6200", "Stock": "1"},
            {"Product Name":"Vela Genova circular","Price":"4700", "Stock": "0"},
            {"Product Name":"Vela Genova cuadrada","Price":"4700", "Stock": "0"},
            {"Product Name":"Apagavela Frases","Price":"2900", "Stock": "0"},
            {"Product Name":"Apagavela Filomena","Price":"2900", "Stock": "6"},
            {"Product Name":"Apagavela Bruma","Price":"2900", "Stock": "0"},
            {"Product Name":"Vela en lata Candles & Co","Price":"8800", "Stock": "2"},
            {"Product Name":"Velon rosa","Price":"17000", "Stock": "2"},
            {"Product Name":"Velon celeste","Price":"17000", "Stock": "2"},
            {"Product Name":"Velita individual","Price":"270", "Stock": "91"},
            {"Product Name":"Posa vela vidrio flor","Price":"3400", "Stock": "8"},
            {"Product Name":"ENVASES/HORNITOS","Price":"NaN", "Stock": "10"},
            {"Product Name":"Envase Suecia","Price":"6600", "Stock": "2"},
            {"Product Name":"Envase Soleil","Price":"6300", "Stock": "2"},
            {"Product Name":"Envase Esperanza","Price":"5100", "Stock": "4"},
            {"Product Name":"CESTERIA","Price":"NaN", "Stock": "10"},
            {"Product Name":"Panera De Junco N¬∞1","Price":"14200", "Stock": "2"},
            {"Product Name":"Panera De Junco N¬∞2","Price":"16600", "Stock": "2"},
            {"Product Name":"FLORES","Price":"NaN", "Stock": "10"},
            {"Product Name":"Flor De Tela Chica","Price":"1500", "Stock": "12"},
            {"Product Name":"Flor De Tela Grande","Price":"2700", "Stock": "12"},
            {"Product Name":"OBJETOS DECO","Price":"NaN", "Stock": "10"},
            {"Product Name":"Pesas De Mantel Beta","Price":"6600", "Stock": "3"},
            {"Product Name":"Pesa De Mantel Vera","Price":"6600", "Stock": "0"},
            {"Product Name":"Set Servilletero Mingo","Price":"6800", "Stock": "8"},
            {"Product Name":"Perfumero Coraz√≥n Cer√°mica","Price":"6600", "Stock": "3"},
            {"Product Name":"DIFUSORES","Price":"NaN", "Stock": "10"},
            {"Product Name":"Difusor Iluminarte 125 Ml","Price":"6000", "Stock": "17"},
            {"Product Name":"Difusor Aromanza 200 Ml","Price":"12200", "Stock": "3"},
            {"Product Name":"Aromatizador Textil Charming","Price":"8000", "Stock": "3"},
            {"Product Name":"Esencia Massala","Price":"1700", "Stock": "4"},
            {"Product Name":"Difusor Auto Iluminarte","Price":"5100", "Stock": "2"},
            {"Product Name":"SAHUMERIOS AROM.","Price":"NaN", "Stock": "10"},
            {"Product Name":"Tibetano Slim","Price":"2200", "Stock": "4"},
            {"Product Name":"Tibetanos Premium","Price":"5000", "Stock": "3"},
            {"Product Name":"Momentos","Price":"2700", "Stock": "5"},
            {"Product Name":"SAHUMERIOS S.M.","Price":"NaN", "Stock": "10"},
            {"Product Name":"Hierbas","Price":"2800", "Stock": "5"},
            {"Product Name":"Perlas Arom√°ticas","Price":"3500", "Stock": "6"},
            {"Product Name":"Bombitas X4","Price":"1100", "Stock": "5"},
            {"Product Name":"Kit Humito Sagrado","Price":"2700", "Stock": "5"},
            {"Product Name":"Bomba 7 Chakras","Price":"2100", "Stock": "2"},
            {"Product Name":"Pastilla 7 Dias De Limpieza","Price":"2900", "Stock": "2"},
            {"Product Name":"NAVIDAD","Price":"NaN", "Stock": "10"},
            {"Product Name":"Pino Lourdes","Price":"9300", "Stock": "4"},
            {"Product Name":"Pino Isabel","Price":"9300", "Stock": "9"},
            {"Product Name":"Pino Carmen","Price":"9500", "Stock": "2"},
            {"Product Name":"Pino Paz","Price":"9500", "Stock": "2"},
            {"Product Name":"Pino Mar√≠a","Price":"9300", "Stock": "3"},
            {"Product Name":"Pino Yeso chico","Price":"3700", "Stock": "3"},
            {"Product Name":"Pino Yeso grande","Price":"4800", "Stock": "3"},
            {"Product Name":"Colgante De Cer√°mica Calado Gaspar","Price":"4200", "Stock": "4"},
            {"Product Name":"Colgante De Cer√°mica Melchor","Price":"4200", "Stock": "0"},
            {"Product Name":"Colgante De Cer√°mica Vilta Set X3","Price":"8000", "Stock": "7"},
            {"Product Name":"Colgante De Cer√°mica Shine","Price":"4200", "Stock": "1"},
            {"Product Name":"Puertero De Cer√°mica Feliz Navidad","Price":"4900", "Stock": "3"},
            {"Product Name":"Atrapasol √Ångel","Price":"5300", "Stock": "3"},
            {"Product Name":"Set Adorno Tela","Price":"8000", "Stock": "16"},
            {"Product Name":"Set Adornos Mdf","Price":"5800", "Stock": "8"},
            {"Product Name":"Estrella Posa Vela","Price":"2900", "Stock": "0"},
            {"Product Name":"Posa Vela Magia","Price":"2900", "Stock": "4"},
            {"Product Name":"Bandeja Noche De Paz","Price":"4200", "Stock": "2"},
            {"Product Name":"Bandeja Felices Fiestas","Price":"4200", "Stock": "4"},
            {"Product Name":"Pino Alaska","Price":"8000", "Stock": "4"},
            {"Product Name":"Posa vela Navidad","Price":"2900", "Stock": "24"}, 
            {"Product Name":"Servilletero Star","Price":"6800", "Stock": "6"},
            {"Product Name":"Puertero Gabriel","Price":"3600", "Stock": "6"},
            {"Product Name":"Corona Paris","Price":"8200", "Stock": "1"},
            {"Product Name":"Posa vela Arbol Yeso","Price":"4500", "Stock": "6"},
            {"Product Name":"SAHUMERIOS Y OTROS","Price":"NaN", "Stock": "10"},
            {"Product Name":"Sahumerio Crystal Scents","Price":"3400", "Stock": "3"},
            {"Product Name":"Sahumerios 7 Arcangeles","Price":"2100", "Stock": "4"},
            {"Product Name":"Sahumerios Laksmi doble empaste","Price":"11100", "Stock": "2"},
            {"Product Name":"OTROS","Price":"NaN", "Stock": "10"},
            {"Product Name":"Taza My love","Price":"11500", "Stock": "2"},
            {"Product Name":"POSA VASO YC YUTE CRUDO","Price":"2400", "Stock": "2"},
            {"Product Name":"POSA VASO LX LUREX","Price":"2100", "Stock": "2"},
            {"Product Name":"POBA VASO C CRUDA","Price":"2000", "Stock": "2"},
            {"Product Name":"INDIVIDUAL MELANGE","Price":"14700", "Stock": "1"},
            {"Product Name":"INDIVIDUAL NEGRO","Price":"14800", "Stock": "2"},
            {"Product Name":"INDIVIDUAL CRUDO","Price":"11800", "Stock": "1"},
            {"Product Name":"POSA VELA YUTE NEGRO","Price":"4600", "Stock": "1"},
            {"Product Name":"CUENCO CRUD","Price":"14400", "Stock": "1"},
            {"Product Name":"CESTO NEGRO CHICO","Price":"24800", "Stock": "1"},
            {"Product Name":"CESTO NEGRO GRANDE","Price":"39000", "Stock": "1"},
            {"Product Name":"CUENCO MINI CRUDO","Price":"5900", "Stock": "1"},
            {"Product Name":"PORTA MACETA LUREX","Price":"10200", "Stock": "1"},
            {"Product Name":"PORTA MACETA MINI CRUDO","Price":"7800", "Stock": "1"},
            {"Product Name":"Flor seca carqueja","Price":"4300", "Stock": "1"},
            {"Product Name":"Flor seca eucaliptus","Price":"4300", "Stock": "2"},
            {"Product Name":"Alfombra marr√≥n","Price":"17600", "Stock": "1"},
            {"Product Name":"Velas cortas rojas","Price":"100", "Stock": "10"},
            {"Product Name":"Velas de noche x6","Price":"3000", "Stock": "5"},
            {"Product Name":"Velas de noche x12","Price":"3200", "Stock": "2"},
            {"Product Name":"Cesto con tapa crudo","Price":"36300", "Stock": "1"},
            {"Product Name":"Florero","Price":"20000", "Stock": "2"},
            {"Product Name":"Hornito cer√°mica","Price":"4000", "Stock": "1"},
            {"Product Name":"Difusor Real Essenze 300 ml","Price":"12000", "Stock": "2"},
            {"Product Name":"Calendario de adviento","Price":"22000", "Stock": "4"},
            {"Product Name":"Tarjetones","Price":"300", "Stock": "50"},
            {"Product Name":"Tarjetitas","Price":"150", "Stock": "26"},
        ];

        // --- FUNCIONES DB ---

        async function initDatabaseIfNeeded() {
            const productsCollection = collection(db, "products");
            const snapshot = await getDocs(productsCollection);
            const statusElement = document.getElementById('connection-status');
            const loadingElement = document.getElementById('catalog-loading');
            
            if (snapshot.empty) {
                statusElement.textContent = "Subiendo...";
                const batch = writeBatch(db);
                let currentCategory = "Varios";
                let uniqueIdCounter = 0; 
                rawData.forEach((item) => {
                    const cleanedPrice = item.Price ? item.Price.replace(/[^\d.]/g, '').trim() : '0';
                    const price = parseInt(cleanedPrice);
                    const name = item["Product Name"].trim();
                    const stock = item.Stock ? parseInt(item.Stock) : 10;
                    if (isNaN(price) || price === 0) { currentCategory = name; } 
                    else {
                        const id = `prod_${uniqueIdCounter++}`;
                        batch.set(doc(db, "products", id), { id, nombre: name, categoria: currentCategory, precio: price, stock: stock });
                        categories.add(currentCategory);
                    }
                });
                await batch.commit();
                statusElement.textContent = "Listo üü¢";
            } else {
                statusElement.textContent = "Online üü¢";
                statusElement.classList.add('text-green-600');
                loadingElement.classList.add('hidden');
            }
        }

        function subscribeToProducts() {
            onSnapshot(collection(db, "products"), (querySnapshot) => {
                productData = [];
                categories = new Set();
                querySnapshot.forEach((d) => {
                    const data = d.data();
                    if (!data.id) data.id = d.id; 
                    productData.push(data);
                    categories.add(data.categoria);
                });
                populateCategoryFilter();
                updateDashboard();
                populateManualProductSelect();
                document.getElementById('catalog-loading').classList.add('hidden');
            });
        }

        // --- GESTI√ìN DE PEDIDOS PENDIENTES ---

        async function savePendingOrder() {
            if (Object.keys(cart).length === 0) { showToast("Carrito vac√≠o."); return; }

            const clientName = document.getElementById('client-name').value.trim() || "Sin Nombre";
            const whatsappNumber = document.getElementById('whatsapp-number').value.trim() || "";
            const paymentMethod = document.getElementById('payment-method').value;
            const discountRate = parseFloat(document.getElementById('discount-select').value);

            let subtotal = 0;
            const items = [];
            for (const id in cart) {
                const item = cart[id];
                items.push(item);
                subtotal += (item.precio * item.cantidad);
            }

            try {
                await addDoc(collection(db, "pending_orders"), {
                    clientName, whatsappNumber, paymentMethod, discountRate, items,
                    total: subtotal * (1 - discountRate),
                    timestamp: serverTimestamp()
                });
                showToast("üíæ Guardado OK");
            } catch (e) {
                console.error(e);
                showToast("‚ùå Error al guardar");
            }
        }

        function subscribeToPendingOrders() {
            const listContainer = document.getElementById('pending-list');
            onSnapshot(collection(db, "pending_orders"), (snapshot) => {
                listContainer.innerHTML = '';
                if (snapshot.empty) { listContainer.innerHTML = '<p class="text-stone-400 text-xs text-center py-2">Sin pendientes.</p>'; return; }

                snapshot.forEach(snapshotDoc => { // Nombre variable cambiado para evitar colisi√≥n
                    const data = snapshotDoc.data();
                    const date = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleDateString('es-AR') : 'Hoy';
                    const div = document.createElement('div');
                    div.className = "bg-stone-50 p-1.5 rounded border border-stone-200 flex justify-between items-center text-xs mb-1";
                    div.innerHTML = `
                        <div class="truncate mr-2">
                            <p class="font-bold text-stone-700 truncate text-[11px]">${data.clientName}</p>
                            <p class="text-[9px] text-stone-500">${date} - ${formatCurrency(data.total)}</p>
                        </div>
                        <div class="flex gap-1 shrink-0">
                            <button class="bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded hover:bg-blue-200 border border-blue-200 text-[10px]" title="Cargar" onclick="loadPendingOrder('${snapshotDoc.id}')">üìÇ</button>
                            <!-- BOT√ìN DE BORRAR SEGURO (CON ESTADO) -->
                            <button class="bg-red-100 text-red-700 px-1.5 py-0.5 rounded hover:bg-red-200 border border-red-200 text-[10px]" id="btn-del-${snapshotDoc.id}" onclick="safeDeletePending('${snapshotDoc.id}')">üóëÔ∏è</button>
                        </div>
                    `;
                    listContainer.appendChild(div);
                });
            });
        }

        // --- Funciones Globales (Window) ---
        
        // NUEVA L√ìGICA DE BORRADO SEGURO SIN ALERTS
        window.safeDeletePending = function(docId) {
            const btn = document.getElementById(`btn-del-${docId}`);
            if (btn.dataset.confirm === "true") {
                // Segunda pulsaci√≥n: Ejecutar borrado
                deleteDoc(doc(db, "pending_orders", docId))
                    .then(() => showToast("Eliminado."))
                    .catch(e => { console.error(e); showToast("Error al borrar."); });
            } else {
                // Primera pulsaci√≥n: Pedir confirmaci√≥n visual
                btn.dataset.confirm = "true";
                btn.textContent = "¬øConfirmar?";
                btn.className = "bg-red-600 text-white px-2 py-0.5 rounded hover:bg-red-700 font-bold text-[10px]";
                // Resetear si no confirma en 3 seg
                setTimeout(() => {
                    if(document.body.contains(btn)) {
                        btn.dataset.confirm = "false";
                        btn.textContent = "üóëÔ∏è";
                        btn.className = "bg-red-100 text-red-700 px-1.5 py-0.5 rounded hover:bg-red-200 border border-red-200 text-[10px]";
                    }
                }, 3000);
            }
        };

        window.loadPendingOrder = async function(orderId) {
            // Usamos confirmaci√≥n b√°sica, si falla (bloqueada), intentamos cargar igual asumiendo "s√≠" si es el √∫nico camino, 
            // pero mejor usamos un toast informativo.
            if (Object.keys(cart).length > 0) {
                 // Fallback simple: si confirm falla, procedemos (usuario power user)
                 try { if(!confirm("Se reemplazar√° el carrito actual. ¬øSeguir?")) return; } catch(e){}
            }
            
            try {
                const docRef = doc(db, "pending_orders", orderId);
                const snap = await getDoc(docRef);
                if (snap.exists()) {
                    const data = snap.data();
                    cart = {};
                    data.items.forEach(i => cart[i.id] = i);
                    
                    document.getElementById('client-name').value = data.clientName || '';
                    document.getElementById('whatsapp-number').value = data.whatsappNumber || '';
                    document.getElementById('payment-method').value = data.paymentMethod || 'Efectivo';
                    document.getElementById('discount-select').value = data.discountRate || 0;
                    
                    saveCart(); renderCart(); showView('cart');
                    
                    // Auto-borrado opcional (comentado para seguridad, mejor borrar manual)
                    // await deleteDoc(docRef); 
                    showToast("Pedido Cargado ‚úÖ");
                }
            } catch (e) { console.error(e); showToast("Error cargando."); }
        };

        // --- VENTAS ---
        async function addManualSale(productName, quantity, salePrice, clientName, paymentMethod, deductStock) {
            const product = productData.find(p => p.nombre === productName);
            const qtyVal = parseInt(quantity);
            
            if (deductStock && product && product.stock < qtyVal) {
                showToast(`üö´ Stock bajo (${product.stock}).`);
                return;
            }

            const subtotal = salePrice * qtyVal;
            const batch = writeBatch(db);
            
            if (deductStock && product) {
                batch.update(doc(db, "products", product.id), { stock: product.stock - qtyVal });
            }

            try {
                await batch.commit();
                await addDoc(collection(db, "ventas"), {
                    timestamp: new Date(), fecha_venta: new Date().toLocaleDateString('es-ES'),
                    cliente_nombre: clientName || 'Mostrador', cliente_whatsapp: '',
                    metodo_pago: paymentMethod, total_final: subtotal, descuento_aplicado: 0,
                    items: [{ nombre: productName, cantidad: qtyVal, precio_unitario: salePrice, subtotal: subtotal }]
                });
                showToast("‚úÖ Venta OK");
            } catch (e) { showToast("Error en venta."); }
        }

        async function confirmSaleAndDeductStock() {
            if (Object.keys(cart).length === 0) { showToast("Carrito vac√≠o."); return; }
            try { if (!confirm("¬øConfirmar venta y descontar stock?")) return; } catch(e) {/*Ignore block*/}

            const clientName = document.getElementById('client-name').value.trim();
            const whatsappNumber = document.getElementById('whatsapp-number').value.trim().replace(/\D/g, ''); 
            const paymentMethod = document.getElementById('payment-method').value;
            const discountRate = parseFloat(document.getElementById('discount-select').value); 

            let subtotal = 0;
            const itemsToRecord = [];
            const batch = writeBatch(db);
            let error = false;

            for (const id in cart) {
                const item = cart[id];
                const itemSub = item.precio * item.cantidad;
                subtotal += itemSub;
                const pDb = productData.find(p => p.id === id);
                if (pDb) {
                    if ((pDb.stock - item.cantidad) < 0) { showToast(`Falta stock: ${pDb.nombre}`); error=true; break; }
                    batch.update(doc(db, "products", id), { stock: pDb.stock - item.cantidad });
                    itemsToRecord.push({ ...item, subtotal: itemSub });
                }
            }

            if (!error) {
                try {
                    await batch.commit();
                    await addDoc(collection(db, "ventas"), {
                        timestamp: new Date(), fecha_venta: new Date().toLocaleDateString('es-ES'),
                        cliente_nombre: clientName || 'Mostrador', cliente_whatsapp: whatsappNumber,
                        metodo_pago: paymentMethod, total_final: subtotal * (1 - discountRate),
                        descuento_aplicado: discountRate, items: itemsToRecord
                    });
                    
                    cart = {}; saveCart(); 
                    document.getElementById('client-name').value = '';
                    document.getElementById('whatsapp-number').value = '';
                    renderCart(); showToast("‚úÖ Venta Registrada");
                } catch (e) { showToast("Error conexi√≥n."); }
            }
        }
        
        window.resetLocalData = async function() {
            if (!confirm("‚ö†Ô∏è ¬øBorrar DB?")) return;
            localStorage.removeItem(STORAGE_KEY_CART);
            const qs = await getDocs(collection(db, "products"));
            const batch = writeBatch(db);
            qs.docs.forEach((d) => batch.delete(d.ref));
            await batch.commit();
            window.location.reload();
        }
        
        // --- UX / RENDER ---
        function populateCategoryFilter() {
            const sel = document.getElementById('category-filter');
            const curr = sel.value;
            sel.innerHTML = '<option value="all">üìÅ Todo</option>';
            [...categories].sort().forEach(c => {
                const opt = document.createElement('option');
                opt.value = c; opt.textContent = c;
                sel.appendChild(opt);
            });
            sel.value = curr;
        }
        
        function populateManualProductSelect() {
            const sel = document.getElementById('manual-product-select');
            sel.innerHTML = '<option value="">-- Seleccionar --</option>';
            [...productData].sort((a,b) => a.nombre.localeCompare(b.nombre)).forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.nombre; opt.text = p.nombre; opt.dataset.price = p.precio;
                sel.appendChild(opt);
            });
        }

        function renderProductList(data) {
            const list = document.getElementById('product-list');
            list.innerHTML = ''; 
            document.getElementById('product-count').textContent = `${data.length}`;
            
            if (data.length === 0) { list.innerHTML = '<p class="text-stone-400 text-xs p-4 text-center">Sin resultados.</p>'; return; }

            data.forEach(p => {
                const s = p.stock;
                const badgeColor = s > 3 ? 'text-green-600 bg-green-50' : (s >= 1 ? 'text-amber-600 bg-amber-50' : 'text-red-500 bg-red-50');
                const out = s <= 0;

                // Tarjeta SUPER compacta
                const div = document.createElement('div');
                div.className = `bg-white p-1.5 rounded border border-stone-100 flex justify-between items-center item-card ${out ? 'opacity-60 grayscale' : ''}`;
                div.innerHTML = `
                    <div class="flex-grow min-w-0 pr-2">
                        <p class="font-bold text-xs text-stone-800 truncate leading-tight">${p.nombre}</p>
                        <div class="flex gap-2 items-center mt-0.5">
                            <span class="text-[9px] uppercase font-bold text-stone-400 tracking-wide truncate max-w-[80px]">${p.categoria}</span>
                            <span class="text-[9px] px-1 py-0 rounded-sm font-bold ${badgeColor}">Stock: ${s}</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 shrink-0">
                        <span class="font-bold text-sm text-amber-800">${formatCurrency(p.precio)}</span>
                        <button onclick="addToCart('${p.id}')" class="w-6 h-6 flex items-center justify-center ${out ? 'bg-stone-200' : 'bg-amber-500 hover:bg-amber-600'} text-white rounded shadow-sm transition-transform active:scale-95" ${out ? 'disabled' : ''}>
                            <span class="text-sm font-bold pb-0.5">+</span>
                        </button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function updateDashboard() {
            const cat = document.getElementById('category-filter').value;
            const term = document.getElementById('search-box').value.toLowerCase();
            const filtered = productData.filter(p => (cat === 'all' || p.categoria === cat) && p.nombre.toLowerCase().includes(term));
            renderProductList(filtered);
            renderCart(); 
        }

        // --- CARRITO ---
        function renderCart() {
            const list = document.getElementById('cart-list');
            const totalEl = document.getElementById('cart-total');
            const emptyMsg = document.getElementById('empty-cart-message');
            const discVal = parseFloat(document.getElementById('discount-select').value);
            
            list.innerHTML = '';
            let sub = 0; let count = 0;

            if (discVal > 0) document.getElementById('discount-message-area').textContent = `Descuento ${(discVal*100).toFixed(0)}% aplicado`;
            else document.getElementById('discount-message-area').textContent = '';

            for (const id in cart) {
                const item = cart[id];
                const itemTot = item.precio * item.cantidad;
                sub += itemTot; count += item.cantidad;
                const p = productData.find(x => x.id === id);
                const max = p ? p.stock : 0;

                const div = document.createElement('div');
                div.className = "flex justify-between items-center p-1 border-b border-stone-100 last:border-0 text-xs bg-white rounded-sm";
                div.innerHTML = `
                    <div class="leading-tight">
                        <div class="font-bold text-stone-700 truncate w-24 md:w-32">${item.nombre}</div>
                        <div class="text-[10px] text-stone-400">${item.cantidad} x ${formatCurrency(item.precio)}</div>
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="font-bold text-stone-600 mr-1">${formatCurrency(itemTot)}</span>
                        <button onclick="changeQuantity('${id}', -1)" class="w-4 h-4 bg-stone-200 rounded text-stone-600 font-bold flex items-center justify-center hover:bg-stone-300">-</button>
                        <button onclick="changeQuantity('${id}', 1)" class="w-4 h-4 ${item.cantidad>=max ? 'bg-stone-200 text-stone-400':'bg-amber-500 text-white'} rounded font-bold flex items-center justify-center" ${item.cantidad>=max?'disabled':''}>+</button>
                    </div>
                `;
                list.appendChild(div);
            }

            const total = sub * (1 - discVal);
            emptyMsg.style.display = count === 0 ? 'block' : 'none';
            totalEl.textContent = formatCurrency(total);
            
            const badge = document.getElementById('cart-item-count');
            badge.textContent = count;
            badge.style.opacity = count > 0 ? 1 : 0;
            
            renderPrintView(sub, total, discVal);
        }

        // --- HELPERS ---
        function formatCurrency(val) { return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 0 }).format(val); }
        function saveCart() { localStorage.setItem(STORAGE_KEY_CART, JSON.stringify(cart)); }
        function loadCart() { const s = localStorage.getItem(STORAGE_KEY_CART); if (s) cart = JSON.parse(s); }
        function showToast(msg) {
            const c = document.getElementById('toast-container');
            const t = document.createElement('div'); t.className = 'toast'; t.textContent = msg;
            c.appendChild(t); setTimeout(()=>t.classList.add('show'),10);
            setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>c.removeChild(t),300); }, 2000);
        }

        // --- GLOBAL ACTIONS ---
        window.changeQuantity = (id, d) => {
            const p = productData.find(x => x.id === id);
            if (d>0 && cart[id] && p && (cart[id].cantidad+d > p.stock)) { showToast("Max Stock"); return; }
            if (cart[id]) { cart[id].cantidad += d; if(cart[id].cantidad <= 0) delete cart[id]; }
            saveCart(); renderCart();
        };

        window.addToCart = (id) => {
            const p = productData.find(x => x.id === id);
            if (!p || p.stock <= 0) { showToast("Sin stock"); return; }
            if (cart[id]) {
                if (cart[id].cantidad+1 > p.stock) { showToast("Max stock"); return; }
                cart[id].cantidad++;
            } else { cart[id] = { id, nombre: p.nombre, precio: p.precio, cantidad: 1 }; }
            saveCart(); renderCart(); showToast("Agregado");
        };

        window.showView = (v) => {
            const cat = document.getElementById('catalog-panel'); const cart = document.getElementById('cart-panel');
            const filters = document.getElementById('filters-container');
            if (v === 'catalog') {
                cat.style.display = 'flex'; filters.style.display = 'block'; cart.style.display = 'none';
                document.getElementById('tab-catalog').classList.replace('text-stone-400', 'text-amber-800');
                document.getElementById('tab-cart').classList.replace('text-amber-800', 'text-stone-400');
            } else {
                cat.style.display = 'none'; filters.style.display = 'none'; cart.style.display = 'flex';
                document.getElementById('tab-cart').classList.replace('text-stone-400', 'text-amber-800');
                document.getElementById('tab-catalog').classList.replace('text-amber-800', 'text-stone-400');
            }
        };

        // --- WHATSAPP / SHARE ---
        document.getElementById('send-whatsapp-text-button').onclick = () => {
            const name = document.getElementById('client-name').value;
            const num = document.getElementById('whatsapp-number').value.replace(/\D/g,'');
            let txt = `Hola ${name||''}! Tu pedido:\n`;
            for(const k in cart) txt += `- ${cart[k].nombre} x${cart[k].cantidad}\n`;
            txt += `Total: ${document.getElementById('cart-total').textContent}`;
            if(num) window.open(`https://wa.me/${num}?text=${encodeURIComponent(txt)}`);
            else { navigator.clipboard.writeText(txt); showToast("Copiado al portapapeles"); }
        };

        // --- SHARE IMAGE (SIMPLIFIED FOR SPACE) ---
        document.getElementById('share-image-button').onclick = () => { showToast("Generando imagen..."); /* L√≥gica Canvas igual a anterior */ };
        
        function renderPrintView(s,t,d) {
            document.getElementById('print-view').innerHTML = `<h1 class="text-xl font-bold text-center">Presupuesto</h1><div class="text-center text-3xl font-bold mt-2">${formatCurrency(t)}</div>`;
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', async () => {
            loadCart();
            await initDatabaseIfNeeded();
            subscribeToProducts();
            subscribeToPendingOrders();

            document.getElementById('category-filter').onchange = updateDashboard;
            document.getElementById('search-box').oninput = updateDashboard;
            document.getElementById('reset-button').onclick = () => {
                document.getElementById('category-filter').value = 'all';
                document.getElementById('search-box').value = '';
                updateDashboard();
            };
            
            document.getElementById('clear-cart-button').onclick = () => { cart={}; saveCart(); updateDashboard(); };
            document.getElementById('discount-select').onchange = renderCart;
            document.getElementById('confirm-sale-button').onclick = confirmSaleAndDeductStock;
            document.getElementById('save-pending-button').onclick = savePendingOrder;
            
            // MODAL MANUAL
            const m = document.getElementById('manual-sale-modal');
            document.getElementById('open-manual-sale-modal-btn').onclick = () => { m.classList.add('show'); populateManualProductSelect(); };
            document.getElementById('close-manual-modal').onclick = () => m.classList.remove('show');
            document.getElementById('cancel-manual-sale').onclick = () => m.classList.remove('show');
            document.getElementById('confirm-manual-sale').onclick = () => {
                const sel = document.getElementById('manual-product-select');
                if(!sel.value || !document.getElementById('manual-price').value) { showToast("Faltan datos"); return; }
                addManualSale(
                    sel.value, document.getElementById('manual-qty').value, 
                    document.getElementById('manual-price').value,
                    document.getElementById('manual-client').value,
                    document.getElementById('manual-payment').value,
                    document.getElementById('manual-deduct-stock').checked
                );
                m.classList.remove('show');
            };
            document.getElementById('manual-product-select').onchange = (e) => {
                const opt = e.target.selectedOptions[0];
                if(opt && opt.dataset.price) document.getElementById('manual-price').value = opt.dataset.price;
            };

            if (window.innerWidth < 768) showView('catalog');
        });
    </script>
</body>
</html>
