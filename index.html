<!DOCTYPE html>
<html lang="es">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat√°logo Vendedor - Blanco & Madera</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fefce8;
        }
        .item-card {
            transition: transform 0.1s ease-out;
            cursor: pointer; 
            pointer-events: auto; 
            /* Para m√≥vil: padding extra para que el contenido no pegue al borde */
            padding-right: 1rem; 
        }
        .item-card:hover {
            background-color: #fffaf0;
        }
        .amber-gradient {
            background-image: linear-gradient(to right, #d4a753, #b18b45);
        }
        /* Toast */
        #toast-container {
            position: fixed; bottom: 20px; right: 20px; z-index: 60; pointer-events: none;
        }
        .toast {
            background-color: rgba(0, 0, 0, 0.8); color: white; padding: 10px 20px;
            border-radius: 25px; margin-bottom: 10px; opacity: 0;
            transition: opacity 0.3s; transform: translateY(20px);
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        
        .loading-overlay {
            position: absolute; inset: 0; background: rgba(255,255,255,0.8);
            display: flex; justify-content: center; align-items: center; z-index: 10;
        }
        
        /* FIX: Estilo para mejorar el scroll en la lista de pendientes en m√≥vil */
        #pending-list {
            /* IMPORTANTE: Permite desplazamiento vertical y evita que el deslizamiento 
               se "coma" el scroll de la p√°gina principal en t√°ctil. */
            touch-action: pan-y; 
            /* Aumento la altura m√°xima para que quepan m√°s √≠tems y el scroll sea m√°s c√≥modo. */
            max-height: 280px; 
            overflow-y: auto;
        }

        @media (max-width: 768px) {
             /* FIX PRINCIPAL: Aumentar el padding inferior de la secci√≥n principal para compensar el .mobile-nav */
             main.container {
                padding-bottom: 5.5rem !important; /* 5.5rem levanta el contenido sobre la barra de navegaci√≥n */
             }
             
             #toast-container { bottom: 80px; left: 50%; transform: translateX(-50%); right: auto; }
             .mobile-filters-hidden { display: none !important; }
             .mobile-nav { position: fixed; bottom: 0; left: 0; width: 100%; z-index: 50; }
             /* Ajuste cr√≠tico para que el bot√≥n de carrito NO cause scroll horizontal */
             .item-card {
                padding-right: 0.5rem !important; /* Reducimos el padding derecho total */
             }
             .item-card > div:last-child {
                flex-shrink: 0; /* Aseguramos que el contenedor del bot√≥n no se comprima */
             }
             /* Habilitar line-clamp en m√≥vil (necesario para el nombre de 2 l√≠neas) */
             .line-clamp-2 {
                 overflow: hidden;
                 display: -webkit-box;
                 -webkit-box-orient: vertical;
                 -webkit-line-clamp: 2;
             }
             /* Ajuste de altura para que el scroll del cat√°logo no sea interrumpido por el nav inferior */
             #product-list {
                 height: calc(100vh - 280px) !important; /* Altura calculada para evitar colisi√≥n con nav y header */
             }
        }
        @media (min-width: 769px) { .mobile-nav { display: none; } }
        @media print { .no-print { display: none !important; } body { background-color: #fff !important; } }
    </style>
</head>
<body class="text-stone-800">

    <header class="bg-white shadow-lg sticky top-0 z-10 no-print">
        <div class="container mx-auto px-4 py-2 flex flex-col items-center">
            <span style="font-family: serif; font-size: 2.25rem; font-weight: 800; color: #1c1917; line-height: 1;">blanco&madera</span>
            <hr class="w-24 border-stone-400 my-0.5">
            <span style="font-size: 0.75rem; letter-spacing: 0.3em; color: #78716c;">SISTEMA VENDEDOR</span>
        </div>
    </header>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8 pt-0"> 
        <div class="py-4 text-center">
            <h1 class="text-4xl font-extrabold text-amber-800">PANEL DE VENTAS</h1>
            <div id="connection-status" class="text-xs text-stone-400 mt-1">Conectando...</div>
        </div>
        
        <div id="toast-container"></div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- PANEL IZQUIERDO: LISTADO -->
            <div class="space-y-6">
                <div id="catalog-panel" class="bg-white p-6 rounded-xl shadow-lg relative min-h-[400px]">
                    <h2 class="text-xl font-semibold mb-4 text-amber-800 border-b pb-2 border-stone-200">Stock Disponible</h2>
                    
                    <!-- FILTROS -->
                    <div class="bg-white rounded-xl mb-4 no-print border-b pb-4 border-stone-100">
                        <!-- MODIFICACI√ìN: Se elimina el filtro de orden. -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div>
                                <label class="block text-sm font-semibold text-stone-700 mb-1">Categor√≠a</label>
                                <select id="category-filter" class="w-full rounded-lg border-stone-300 shadow-sm p-2"><option value="all">Todas</option></select>
                            </div>
                            <div class="col-span-1 md:col-span-1">
                                <label class="block text-sm font-semibold text-stone-700 mb-1">Buscar</label>
                                <input type="text" id="search-box" placeholder="Nombre..." class="w-full rounded-lg border-stone-300 shadow-sm p-2">
                            </div>
                            <div class="md:self-end">
                                <button id="reset-button" class="w-full bg-stone-500 text-white font-bold py-2.5 rounded-lg hover:bg-stone-600">Mostrar Todos</button>
                            </div>
                        </div>
                    </div>

                    <div id="catalog-loading" class="loading-overlay">
                        <div class="text-amber-600 font-bold animate-pulse">Cargando productos...</div>
                    </div>
                    
                    <div id="product-list" class="overflow-y-auto h-[60vh] md:h-[70vh] pr-4 space-y-2"></div>
                </div>

                <!-- PANEL GESTION -->
                <div class="bg-white p-6 rounded-xl shadow-lg no-print">
                    <h2 class="text-xl font-semibold mb-4 text-stone-700 border-b pb-2">Herramientas de Gesti√≥n</h2>
                    <div class="flex flex-col space-y-3">
                        <button id="download-sales-report-button" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow-md hover:bg-blue-700">‚¨áÔ∏è Descargar Historial de Ventas</button>
                        <button onclick="openManualSaleModal()" class="w-full bg-red-500 text-white font-bold py-3 rounded-lg shadow-md hover:bg-red-600">‚ûï Registrar Venta Manual</button>
                        
                        <!-- BOT√ìN DE CARGA MASIVA -->
                        <button onclick="openBulkUploadModal()" class="w-full bg-amber-700 text-white font-bold py-3 rounded-lg shadow-md hover:bg-amber-800 border-2 border-amber-600 mt-4">
                             ‚è´ Cargar/Actualizar Productos Masivamente
                        </button>
                        
                    </div>
                </div>
            </div>
            
            <!-- PANEL DERECHO: CARRITO -->
            <div id="cart-panel" class="hidden md:flex flex-col bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold mb-4 text-amber-800 border-b pb-2 border-stone-200">Cotizaci√≥n</h2>
                <div class="mb-4 no-print"><input type="text" id="client-name" placeholder="Cliente" class="w-full rounded-lg border-stone-300 p-2 shadow-sm"></div>
                <div class="mb-4 no-print"><input type="tel" id="whatsapp-number" placeholder="WhatsApp (549...)" class="w-full rounded-lg border-stone-300 p-2 shadow-sm"></div>
                <div class="mb-4 no-print"><select id="payment-method" class="w-full rounded-lg border-stone-300 p-2 shadow-sm"><option value="Efectivo">Efectivo</option><option value="Transferencia">Transferencia</option><option value="Tarjeta">Tarjeta</option><option value="Otro">Otro</option></select></div>
                
                <div class="flex-grow relative">
                    <div id="cart-list" class="absolute inset-0 overflow-y-auto pr-4 space-y-2"></div>
                    <p id="empty-cart-message" class="text-stone-500 text-center mt-8 pointer-events-none">Carrito vac√≠o.</p>
                </div>

                <div class="mt-4 pt-4 border-t-2 border-amber-500/50">
                    <div class="mb-4 no-print"><label class="block text-sm font-bold mb-1">Descuento:</label><select id="discount-select" class="w-full rounded-lg border-stone-300 p-2"><option value="0">0%</option><option value="0.05">5%</option><option value="0.10">10%</option><option value="0.15">15%</option><option value="0.20">20%</option></select></div>
                    <div class="flex justify-between items-center mb-4"><span class="text-2xl font-bold">TOTAL:</span><span id="cart-total" class="text-4xl font-extrabold text-amber-800">$0</span></div>
                    <div class="space-y-3 no-print">
                        <button id="save-pending-button" class="w-full bg-stone-700 text-white font-bold py-3 rounded-lg shadow-xl hover:bg-stone-800">üíæ Guardar Pendiente</button>
                        <button id="confirm-sale-button" class="w-full bg-red-700 text-white font-bold py-3 rounded-lg shadow-xl hover:bg-red-800">‚ùå Registrar Venta</button>
                        <div class="grid grid-cols-2 gap-3 mt-2"><button id="send-whatsapp-text-button" class="bg-green-600 text-white font-bold py-2 rounded-lg shadow-md">üí¨ WhatsApp</button><button id="share-image-button" class="bg-amber-500 text-white font-bold py-2 rounded-lg shadow-md">üñºÔ∏è Imagen</button></div>
                        <div class="grid grid-cols-2 gap-3 mt-2"><button id="print-button" class="bg-stone-500 text-white font-bold py-2 rounded-lg shadow-md">üñ®Ô∏è Imprimir</button><button id="clear-cart-button" class="bg-red-500/50 text-white font-bold py-2 rounded-lg shadow-md">üóëÔ∏è Vaciar</button></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- PEDIDOS PENDIENTES -->
        <div class="bg-white p-6 rounded-xl shadow-lg no-print mt-6">
            <h2 class="text-xl font-semibold mb-4 text-amber-800 border-b pb-2">‚è≥ Pedidos Pendientes</h2>
            <div id="pending-list" class="space-y-2"></div>
        </div>
    </main>

    <!-- MODAL CARGA MASIVA (NUEVO) -->
    <div id="bulk-upload-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-2xl mx-4">
            <h3 class="text-2xl font-bold mb-4 text-amber-700 border-b pb-2">‚è´ Carga Masiva de Productos</h3>
            <p class="mb-4 text-sm text-stone-600">Pega los datos de tu Excel o lista aqu√≠. Separa cada producto por una nueva l√≠nea.</p>
            
            <div class="bg-stone-100 p-3 rounded-lg mb-4 text-xs font-mono">
                <p class="font-bold text-stone-700 mb-1">Formato requerido (separado por comas):</p>
                <p class="text-stone-500">Nombre,Categor√≠a,Precio,Stock,URL_Imagen</p>
                <p class="text-stone-500 mt-2">Ejemplo: Vela Lavanda,VELAS,5600,10,https://img.link</p>
            </div>

            <textarea id="bulk-data-textarea" rows="10" placeholder="Pega aqu√≠ la lista de productos..." class="w-full border border-stone-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-amber-400 outline-none"></textarea>
            
            <p id="bulk-error-message" class="text-red-600 text-sm mt-2 hidden">Error en el formato de una l√≠nea.</p>

            <div class="flex justify-between space-x-3 mt-4">
                <button onclick="closeBulkUploadModal()" class="w-1/2 bg-stone-300 text-stone-800 font-bold py-3 rounded-lg hover:bg-stone-400 transition">Cancelar</button>
                <button onclick="handleBulkUpload()" class="w-1/2 bg-amber-600 text-white font-bold py-3 rounded-lg shadow-xl hover:bg-amber-700 transition">
                    Procesar y Subir
                </button>
            </div>
        </div>
    </div>
    
    <!-- MODAL VISTA R√ÅPIDA -->
    <div id="product-quickview-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-xl mx-4 relative">
            <button onclick="closeProductModal()" class="absolute top-4 right-4 text-stone-500 hover:text-red-600 text-3xl">&times;</button>
            <h3 id="modal-product-name" class="text-2xl font-bold text-amber-800 pr-8 mb-4"></h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-stone-100 rounded-lg flex items-center justify-center p-2 h-[300px]">
                    <img id="modal-product-image" src="" class="max-h-full max-w-full object-contain shadow-sm">
                </div>
                <div class="flex flex-col justify-center">
                    <p class="text-sm font-semibold text-stone-500">Categor√≠a:</p><p id="modal-product-category" class="text-lg font-medium text-stone-800 mb-4"></p>
                    <p class="text-sm font-semibold text-stone-500">Precio:</p><p id="modal-product-price" class="text-3xl font-extrabold text-amber-800 mb-4"></p>
                    <p id="modal-product-stock" class="text-lg font-bold text-stone-700 mb-6"></p>
                    <button id="modal-add-to-cart-button" class="w-full amber-gradient text-white font-bold py-3 rounded-lg shadow-lg hover:opacity-90">üõí Agregar a Cotizaci√≥n</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL VENTA MANUAL -->
    <div id="manual-sale-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md mx-4">
            <h3 class="text-xl font-bold mb-4 text-red-700 border-b pb-2">‚ûï Venta Manual</h3>
            <div class="space-y-4">
                <input type="text" id="manual-sale-product-name" placeholder="Producto" class="w-full border p-2 rounded">
                <div class="grid grid-cols-2 gap-2"><input type="number" id="manual-sale-quantity" value="1" class="w-full border p-2 rounded"><input type="number" id="manual-sale-price" placeholder="Precio" class="w-full border p-2 rounded"></div>
                <input type="text" id="manual-sale-client-name" value="Venta Externa" class="w-full border p-2 rounded">
                <select id="manual-sale-payment" class="w-full border p-2 rounded"><option value="Efectivo">Efectivo</option><option value="Transferencia">Transferencia</option><option value="Tarjeta">Tarjeta</option><option value="Otro">Otro</option></select>
                <div class="flex items-center"><input type="checkbox" id="manual-sale-deduct-stock" checked class="mr-2"> <label>Descontar Stock</label></div>
                <div class="flex gap-2"><button onclick="closeManualSaleModal()" class="flex-1 bg-gray-300 py-2 rounded font-bold">Cancelar</button><button onclick="handleManualSale()" class="flex-1 bg-red-600 text-white font-bold py-2 rounded-lg">Registrar</button></div>
            </div>
        </div>
    </div>

    <!-- MODAL DE CONFIRMACI√ìN CUSTOM (FIX PARA ELIMINAR PENDIENTE) -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-xs mx-4">
            <h3 id="conf-title" class="text-xl font-bold mb-4 text-stone-800">Confirmar Acci√≥n</h3>
            <p id="conf-message" class="mb-6 text-stone-600">¬øEst√°s seguro que deseas realizar esta acci√≥n?</p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeConfirmationModal()" class="bg-stone-300 text-stone-800 font-bold py-2 px-4 rounded-lg hover:bg-stone-400">Cancelar</button>
                <button id="conf-confirm-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- NAV M√ìVIL -->
    <div class="mobile-nav bg-white shadow-2xl p-3 border-t border-stone-200 flex justify-around">
        <button onclick="showView('catalog')" class="flex flex-col items-center text-amber-800 font-bold"><span class="text-2xl">üõí</span><span class="text-xs">Cat√°logo</span></button>
        <button onclick="showView('cart')" class="flex flex-col items-center text-stone-500 font-bold"><span class="text-2xl">üìù</span><span class="text-xs">Cotizaci√≥n</span></button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, onSnapshot, addDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "", 
            authDomain: "blanco-y-madera-17214.firebaseapp.com",
            projectId: "blanco-y-madera-17214",
            storageBucket: "blanco-y-madera-17214.appspot.com",
            messagingSenderId: "147976695842",
            appId: "1:147976695842:web:e165092b1fee5aa1e99a7b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let productData = [];
        let cart = {};
        let categories = new Set();
        const STORAGE_KEY = 'bm_cart_v2';
        
        // Funci√≥n de formato de moneda (usada en todo el script)
        function formatCurrency(v) { return new Intl.NumberFormat('es-AR', {style:'currency', currency: 'ARS', minimumFractionDigits:0}).format(v); }
        
        // --- FUNCIONES GLOBALES DE MODALES ---
        window.openQuickView = function(id) {
            const product = productData.find(p => p.id === id);
            if (!product) return;
            const modal = document.getElementById('product-quickview-modal');
            document.getElementById('modal-product-name').textContent = product.nombre;
            document.getElementById('modal-product-category').textContent = product.categoria;
            document.getElementById('modal-product-price').textContent = formatCurrency(product.precio);
            
            // L√≥gica para obtener la imagen principal del array 'images' (SIN cache buster aqu√≠ para no romper el token de Firebase Storage)
            let modalImgUrl = product.imageUrl || product.ImageUrl || (product.images && product.images.length > 0 ? product.images[0] : null);

            document.getElementById('modal-product-image').src = modalImgUrl || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ccc' stroke-width='1'%3E%3Crect x='3' y='3' width='18' height='18' rx='2' ry='2'/%3E%3Ccircle cx='8.5' cy='8.5' r='1.5'/%3E%3Cpolyline points='21 15 16 10 5 21'/%3E%3C/svg%3E";
            
            const stockEl = document.getElementById('modal-product-stock');
            const addBtn = document.getElementById('modal-add-to-cart-button');
            
            if (product.stock <= 0) {
                stockEl.innerHTML = '<span class="text-red-600">‚ùå Sin Stock</span>';
                addBtn.disabled = true; addBtn.classList.add('opacity-50');
            } else {
                stockEl.innerHTML = `<span class="text-green-600">‚úÖ ${product.stock} unidades</span>`;
                addBtn.disabled = false; addBtn.classList.remove('opacity-50');
            }
            addBtn.onclick = () => { addToCart(id); closeProductModal(); };
            modal.style.display = 'flex';
        };
        window.closeProductModal = () => document.getElementById('product-quickview-modal').style.display = 'none';
        window.openManualSaleModal = () => document.getElementById('manual-sale-modal').style.display = 'flex';
        window.closeManualSaleModal = () => document.getElementById('manual-sale-modal').style.display = 'none';

        // --- FUNCIONES DEL MODAL DE CONFIRMACI√ìN CUSTOM (FIX DEL BUG) ---
        let confirmationCallback = null;

        window.openConfirmationModal = (title, message, callback) => {
            document.getElementById('conf-title').textContent = title;
            document.getElementById('conf-message').textContent = message;
            confirmationCallback = callback;
            document.getElementById('conf-confirm-btn').onclick = () => {
                closeConfirmationModal();
                if (confirmationCallback) {
                    confirmationCallback();
                }
            };
            document.getElementById('confirmation-modal').style.display = 'flex';
        };

        window.closeConfirmationModal = () => {
            document.getElementById('confirmation-modal').style.display = 'none';
            confirmationCallback = null;
        };

        // --- CARGA MASIVA L√ìGICA ---
        window.openBulkUploadModal = () => {
            document.getElementById('bulk-data-textarea').value = '';
            document.getElementById('bulk-error-message').classList.add('hidden');
            document.getElementById('bulk-upload-modal').style.display = 'flex';
        };

        window.closeBulkUploadModal = () => {
            document.getElementById('bulk-upload-modal').style.display = 'none';
        };

        window.handleBulkUpload = async () => {
            const dataText = document.getElementById('bulk-data-textarea').value.trim();
            const errorEl = document.getElementById('bulk-error-message');
            errorEl.classList.add('hidden');
            if (!dataText) return;

            // La clave aqu√≠ es dividir por saltos de l√≠nea primero, y luego cada l√≠nea por comas.
            // Esto asegura que las l√≠neas con comas extra (como la que causaba el error) se manejen correctamente.
            const lines = dataText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            const batch = writeBatch(db);
            let errorsFound = false;
            let updatesCount = 0;
            let addsCount = 0;

            for (let i = 0; i < lines.length; i++) {
                // Nombre,Categor√≠a,Precio,Stock,URL_Imagen
                // Usamos una expresi√≥n regular para dividir, pero no dentro de comillas si las comas est√°n dentro del nombre (aunque el formato no las contempla)
                const parts = lines[i].split(',').map(p => p.trim());
                
                // Validamos que al menos tengamos 4 partes obligatorias y un m√°ximo de 5
                if (parts.length < 4 || parts.length > 5 || isNaN(parseFloat(parts[2])) || isNaN(parseInt(parts[3]))) {
                    errorsFound = true;
                    errorEl.textContent = `Error en la L√≠nea ${i + 1}: El formato debe ser Nombre,Categor√≠a,Precio,Stock[,URL_Imagen]. Precio o Stock inv√°lidos.`;
                    errorEl.classList.remove('hidden');
                    return;
                }

                const [nombre, categoria, precioStr, stockStr, imageUrl] = parts;
                const precio = parseFloat(precioStr);
                const stock = parseInt(stockStr);

                const existingProduct = productData.find(p => (p.nombre || '').toLowerCase() === nombre.toLowerCase());

                const newProductData = {
                    nombre: nombre,
                    categoria: categoria,
                    precio: precio,
                    stock: stock,
                };
                
                // Si existe imageUrl y empieza por http, la agregamos al array 'images'
                if (imageUrl && imageUrl.startsWith('http')) {
                    newProductData.images = [imageUrl]; 
                }

                if (existingProduct) {
                    const docRef = doc(db, "products", existingProduct.id);
                    batch.update(docRef, newProductData);
                    updatesCount++;
                } else {
                    const docRef = doc(collection(db, "products"));
                    batch.set(docRef, { 
                        ...newProductData,
                        id: docRef.id
                    });
                    addsCount++;
                }
            }

            try {
                await batch.commit();
                showToast(`‚úÖ Proceso finalizado: Agregados ${addsCount}, Actualizados ${updatesCount}.`);
                closeBulkUploadModal();
            } catch (e) {
                errorEl.textContent = `Error cr√≠tico al subir a Firebase: ${e.message}`;
                errorEl.classList.remove('hidden');
            }
        };

        // --- L√ìGICA DE CARRITO Y VENTAS ---

        window.addToCart = function(id) {
            const product = productData.find(p => p.id === id);
            if (!product) return;
            if (!cart[id]) cart[id] = { ...product, cantidad: 0 };
            if (cart[id].cantidad + 1 > product.stock) return showToast(`‚ö†Ô∏è Stock m√°ximo alcanzado`);
            cart[id].cantidad++; saveCart(); renderCart(); showToast(`üõí ${product.nombre} agregado`);
        };

        window.changeQuantity = function(id, delta) {
            if (!cart[id]) return;
            const newQty = cart[id].cantidad + delta;
            const product = productData.find(p => p.id === id);
            if (newQty > product.stock) return showToast(`‚ö†Ô∏è No hay m√°s stock`);
            if (newQty <= 0) delete cart[id]; else cart[id].cantidad = newQty;
            saveCart(); renderCart();
        };

        function renderProductList(data) {
            const list = document.getElementById('product-list');
            list.innerHTML = '';
            if (data.length === 0) return list.innerHTML = '<p class="text-center text-stone-500">Sin resultados.</p>';
            data.forEach(p => {
                const item = document.createElement('div');
                const isNoStock = p.stock <= 0;
                const opacity = isNoStock ? 'opacity-60' : '';
                
                // === AJUSTE PRINCIPAL: Obtener la imagen del array 'images' y aplicar Cache Buster correctamente ===
                let imgUrl = (p.images && p.images.length > 0 ? p.images[0] : p.imageUrl || p.ImageUrl);
                
                // Aplicar cache-buster S√ìLO si la URL no contiene el token de Firebase Storage
                if (imgUrl && imgUrl.startsWith('http') && !imgUrl.includes('token=')) {
                    // Si no hay token, es probable que sea una URL de Google Storage simple, a√±adimos el cache-buster
                    // Aseguramos que solo tengamos el URL base antes de a√±adir el par√°metro
                    imgUrl = `${imgUrl.split('?')[0]}?v=${p.id}`; 
                }
                const imgHtml = imgUrl ? `<img src="${imgUrl}" class="w-10 h-10 rounded object-cover bg-stone-200">` : `<div class="w-10 h-10 rounded bg-stone-200 flex items-center justify-center text-lg">üñºÔ∏è</div>`;
                // === FIN AJUSTE PRINCIPAL ===

                
                // Determina las clases para el badge de stock
                const stockBadge = p.stock > 3 ? 'bg-green-600' : (p.stock > 0 ? 'bg-amber-500' : 'bg-red-600');
                const stockText = p.stock > 0 ? `${p.stock}` : '0'; // Solo la cantidad

                // INICIO MODIFICACI√ìN V5: Nombre y Stock en la misma l√≠nea
                item.className = `bg-white p-3 rounded-xl border border-stone-100 flex items-center justify-between item-card ${opacity}`;
                item.onclick = (e) => { 
                    if (e.target.closest('.cart-btn') || e.target.closest('.stock-edit-btn')) return; // Evita abrir modal si toca botones
                    openQuickView(p.id); 
                };

                item.innerHTML = `
                    <!-- IZQUIERDA: IMAGEN + NOMBRE + STOCK (Ahora en la misma l√≠nea) -->
                    <div class="flex items-start gap-2 flex-grow min-w-0 pr-1">
                        <!-- IMAGEN (W-10) -->
                        <div class="flex-shrink-0">${imgHtml}</div>
                        
                        <!-- NOMBRE Y STOCK BADGE (flex-grow para que ocupe el espacio disponible) -->
                        <div class="min-w-0 flex-grow pr-1 flex flex-col">
                            <!-- Contenedor del nombre y stock para que est√©n alineados en la parte superior -->
                            <div class="flex items-start gap-2 w-full">
                                <!-- Nombre con truncate de 2 l√≠neas -->
                                <p class="font-bold text-stone-800 leading-snug line-clamp-2 text-sm flex-grow min-w-0">${p.nombre}</p> 
                                
                                <!-- STOCK Badge (alineado arriba, se vuelve clickeable para editar) -->
                                <span class="${stockBadge} text-white px-2 py-0.5 rounded-full text-[10px] font-bold flex-shrink-0 mt-0.5 cursor-pointer" onclick="event.stopPropagation(); editStock('${p.id}', ${p.stock})">
                                    ${stockText} 
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- DERECHA: PRECIO Y BOT√ìN (compacto vertical) -->
                    <div class="flex flex-col items-end gap-1 flex-shrink-0 pl-1">
                        <!-- Precio reducido a text-sm -->
                        <span class="font-extrabold text-amber-800 text-sm flex-shrink-0">${formatCurrency(p.precio)}</span>
                        
                        <!-- Bot√≥n Carrito reducido a w-8 h-8 -->
                        <button class="cart-btn rounded-full shadow-md text-white ${isNoStock?'bg-stone-400':'amber-gradient hover:opacity-90'} w-8 h-8 flex items-center justify-center flex-shrink-0 text-sm" ${isNoStock?'disabled':''} onclick="addToCart('${p.id}')">
                            üõí
                        </button>
                    </div>
                `;
                list.appendChild(item);
            });
        }
        // FIN MODIFICACI√ìN V5

        const q = collection(db, "products");
        onSnapshot(q, (snapshot) => {
            productData = []; categories = new Set();
            // Mapeo inicial de productos y categor√≠as
            snapshot.forEach(doc => {
                const d = doc.data(); d.id = doc.id; productData.push(d);
                if(d.categoria) categories.add(d.categoria);
            });
            document.getElementById('catalog-loading').style.display = 'none';
            document.getElementById('connection-status').textContent = "üü¢ Conectado";
            document.getElementById('connection-status').classList.add('text-green-600');
            
            // Llenar el filtro de categor√≠as
            const catSelect = document.getElementById('category-filter');
            const currentCat = catSelect.value;
            catSelect.innerHTML = '<option value="all">Todas</option>';
            Array.from(categories).sort().forEach(c => catSelect.innerHTML += `<option value="${c}">${c}</option>`);
            catSelect.value = currentCat;
            
            updateDashboard();
        }, (err) => {
            console.error("Error al obtener productos:", err);
            document.getElementById('connection-status').textContent = "üî¥ Error de conexi√≥n";
        });

        // Modificaci√≥n de updateDashboard para aplicar SIEMPRE orden alfab√©tico por nombre
        function updateDashboard() {
            const cat = document.getElementById('category-filter').value;
            const search = document.getElementById('search-box').value.toLowerCase();
            
            // 1. Filtrado
            let filtered = productData.filter(p => (cat === 'all' || p.categoria === cat) && (p.nombre||'').toLowerCase().includes(search));

            // 2. Ordenamiento: SIEMPRE por Nombre (A-Z)
            filtered.sort((a, b) => {
                const nameA = (a.nombre || '').toLowerCase();
                const nameB = (b.nombre || '').toLowerCase();
                if (nameA < nameB) return -1;
                if (nameA > nameB) return 1;
                return 0;
            });

            // 3. Renderizado
            renderProductList(filtered); 
            renderCart();
        }

        function renderCart() {
            const list = document.getElementById('cart-list'); 
            const totalEl = document.getElementById('cart-total');
            const emptyEl = document.getElementById('empty-cart-message');
            const discountSelect = document.getElementById('discount-select');

            list.innerHTML = ''; 
            let subtotal = 0, count = 0;
            for(const id in cart) {
                const item = cart[id];
                subtotal += item.precio * item.cantidad; count += item.cantidad;
                list.innerHTML += `<div class="bg-white p-2 rounded border flex justify-between items-center mb-2"><div><div class="font-bold text-sm">${item.nombre}</div><div class="text-xs text-stone-500">${formatCurrency(item.precio)} x ${item.cantidad}</div></div><div class="flex items-center gap-2"><span class="font-bold">${formatCurrency(item.precio*item.cantidad)}</span><button onclick="changeQuantity('${id}', -1)" class="px-2 bg-stone-200 rounded text-stone-700">-</button><button onclick="changeQuantity('${id}', 1)" class="px-2 bg-amber-500 text-white rounded">+</button></div></div>`;
            }
            const disc = parseFloat(discountSelect.value) || 0;
            const discountAmount = subtotal * disc;
            const total = subtotal * (1 - disc);

            
            // Renderizar resumen del descuento
            if (count > 0) {
                 const summaryDiv = document.createElement('div');
                 summaryDiv.className = 'mt-3 pt-2 border-t border-stone-200';
                 if (disc > 0) {
                     summaryDiv.innerHTML += `<div class="flex justify-between text-sm text-stone-500"><span>Subtotal:</span><span>${formatCurrency(subtotal)}</span></div>`;
                     summaryDiv.innerHTML += `<div class="flex justify-between font-bold text-red-600 mb-2"><span>Descuento (${(disc * 100).toFixed(0)}%):</span><span>-${formatCurrency(discountAmount)}</span></div>`;
                 }
                 list.appendChild(summaryDiv);
            }
            
            document.getElementById('cart-total').textContent = formatCurrency(total);
            
            // Manejo de Carrito Vac√≠o
            if (emptyEl) emptyEl.style.display = count ? 'none' : 'block';
        }

        function saveCart() { localStorage.setItem(STORAGE_KEY, JSON.stringify(cart)); }
        function loadCart() { const s = localStorage.getItem(STORAGE_KEY); if(s) cart = JSON.parse(s); renderCart(); }
        function showToast(msg) { 
            const t = document.createElement('div'); t.className='toast show'; t.textContent=msg; 
            document.getElementById('toast-container').appendChild(t);
            setTimeout(()=>t.remove(), 2000);
        }
        
        // Funci√≥n para la edici√≥n de stock (simulada)
        window.editStock = async (id, currentStock) => {
            const product = productData.find(p => p.id === id);
            // Usamos openConfirmationModal para cualquier confirmaci√≥n, aunque aqu√≠ usamos prompt() para la entrada de datos.
            const newStock = window.prompt(`Stock actual de ${product.nombre}: ${currentStock}.\nIngresa el nuevo stock:`);
            if (newStock === null || isNaN(parseInt(newStock))) return;
            
            const stockValue = parseInt(newStock);
            if (stockValue < 0) { 
                window.alert("El stock no puede ser negativo."); 
                return; 
            }

            try {
                // Actualizar en Firebase
                await updateDoc(doc(db, "products", id), { stock: stockValue });
                showToast("Stock actualizado ‚úÖ");
            } catch (error) {
                console.error("Error al actualizar stock:", error);
                window.alert("Hubo un error al guardar el stock.");
            }
        };


        document.getElementById('category-filter').onchange = updateDashboard;
        document.getElementById('search-box').oninput = updateDashboard;
        // El filtro de orden ya no existe, por lo que quitamos el evento onchange: document.getElementById('sort-filter').onchange = updateDashboard;
        document.getElementById('reset-button').onclick = () => { 
            document.getElementById('category-filter').value='all'; 
            document.getElementById('search-box').value=''; 
            // document.getElementById('sort-filter').value='default'; // Se elimin√≥
            updateDashboard(); 
        };
        document.getElementById('discount-select').onchange = renderCart;
        document.getElementById('clear-cart-button').onclick = () => { cart={}; saveCart(); renderCart(); };
        document.getElementById('print-button').onclick = () => window.print();
        
        // Funci√≥n corregida para la descarga de ventas (Vuelve al formato de una fila por VENTA COMPLETA)
        window.downloadSalesReport = async () => {
            showToast("Cargando reporte de ventas...");
            console.log("--- INICIANDO DESCARGA DE REPORTE ---");
            
            try {
                console.log("Intentando obtener datos de 'ventas'...");
                const salesSnapshot = await getDocs(collection(db, "ventas"));
                
                console.log(`Datos obtenidos: ${salesSnapshot.docs.length} documentos.`);
                
                if (salesSnapshot.empty) {
                    showToast("‚ö†Ô∏è No hay ventas registradas para descargar.");
                    console.log("Finalizado: Snapshot vac√≠o.");
                    return;
                }

                // Definir la cabecera del CSV
                let csvContent = '\uFEFF' + "Fecha,Cliente,WhatsApp,M√©todo Pago,Descuento (%),Total Final,Items Vendidos\n";
                
                let salesCount = 0;

                salesSnapshot.forEach((doc) => {
                    salesCount++;
                    const sale = doc.data();
                    
                    // Manejo seguro de campos que podr√≠an ser opcionales o faltar
                    const date = sale.fecha_venta || '';
                    const client = sale.cliente_nombre || '';
                    const whatsapp = sale.cliente_whatsapp || '';
                    const method = sale.metodo_pago || '';
                    // Convertir el descuento de decimal (ej: 0.10) a porcentaje (ej: 10%)
                    const discount = sale.descuento_aplicado !== undefined ? (sale.descuento_aplicado * 100).toFixed(0) + '%' : '0%';
                    const total = sale.total_final || 0;
                    
                    // Procesar los √≠tems en un formato de texto √∫nico para una columna
                    const items = Array.isArray(sale.items) ? sale.items : [];
                    let itemsString = items.map(item => {
                        const product = item.nombre || 'N/A';
                        const qty = item.cantidad || 0;
                        const price = item.precio_unitario || 0;
                        // Formato: "Nombre Producto (x Cantidad) @ Precio Unitario"
                        return `${product} (x${qty}) @ ${formatCurrency(price)}`;
                    }).join(' | '); // Separar √≠tems con un pipe

                    // Creaci√≥n de la fila CSV (una fila por venta)
                    const rowData = [date, client, whatsapp, method, discount, total, itemsString];
                    
                    // Envolver cada item en comillas y escapar comillas internas para CSV seguro
                    const row = rowData.map(item => `"${String(item).replace(/"/g, '""')}"`).join(',');
                    csvContent += row + '\n';
                    
                });
                
                if (salesCount === 0) {
                    showToast("‚ö†Ô∏è No se encontraron ventas para descargar.");
                    console.log("Finalizado: salesCount 0.");
                    return;
                }
                
                console.log(`CSV generado con √©xito, ${salesCount} ventas procesadas.`);

                // Crear el Blob y el enlace de descarga
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                const timestamp = new Date().toISOString().slice(0, 10);
                link.setAttribute('download', `reporte_ventas_${timestamp}.csv`);
                
                // Simular el clic en el enlace y removerlo
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast("‚úÖ Reporte descargado.");
                console.log("--- DESCARGA DE REPORTE FINALIZADA CON √âXITO ---");

            } catch (error) {
                console.error("Error al descargar el reporte:", error);
                showToast("‚ùå Error al obtener datos de ventas. Revisa la Consola.");
            }
        };

        // --- L√çNEA AGREGADA PARA CONECTAR EL BOT√ìN ---
        document.getElementById('download-sales-report-button').onclick = window.downloadSalesReport;


        // CORRECCI√ìN: Funci√≥n de WhatsApp para asegurar que se abre la ventana
        document.getElementById('send-whatsapp-text-button').onclick = () => {
            if (Object.keys(cart).length === 0) {
                 showToast("‚ö†Ô∏è El carrito est√° vac√≠o.");
                 return;
            }

            const clientName = document.getElementById('client-name').value || 'Cliente';
            const whatsappNumber = document.getElementById('whatsapp-number').value.replace(/\D/g,''); // Obtener el n√∫mero
            
            // Usar window.alert en lugar de prompt() o confirm() para informar de errores.
            if (!whatsappNumber) {
                 window.alert("Por favor, introduce un n√∫mero de WhatsApp (549...)");
                 return;
            }
            
            let subtotal = 0;
            const items = [];
            for(let id in cart) { 
                let i = cart[id]; 
                subtotal += i.precio * i.cantidad;
                items.push({ nombre: i.nombre, cantidad: i.cantidad, subtotal: i.precio * i.cantidad });
            }
            const disc = parseFloat(document.getElementById('discount-select').value);
            const totalWithDiscount = subtotal * (1 - disc);
            const formattedDate = new Date().toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });

            // INICIO DEL MENSAJE 
            const summaryLines = [
                `Hola, ${clientName}!`,
                '',
                `Te env√≠o el detalle de tu compra en Blanco & Madera el ${formattedDate}`,
                ''
            ];

            items.forEach((item) => {
                // Formato: ‚Ä¢ Apagavela Filomena x 1: $ 2.900
                summaryLines.push(` ‚Ä¢ ${item.nombre} x ${item.cantidad}: ${formatCurrency(item.subtotal)}`);
            });

            summaryLines.push('');
            summaryLines.push('--------------------------');
            summaryLines.push(`TOTAL FINAL: ${formatCurrency(totalWithDiscount)}`); 
            summaryLines.push('--------------------------');
            
            // Alias
            summaryLines.push(`Para abonar con Transferencia, usa el siguiente alias:`);
            summaryLines.push(`*sofiricca*`);
            summaryLines.push('--------------------------');

            summaryLines.push('');
            sumaryLines.push("¬°Muchas gracias por confiar en Blanco & Madera!");
            // FIN DEL MENSAJE 

            const whatsappText = encodeURIComponent(summaryLines.join('\n'));
            
            // CORRECCI√ìN CLAVE: Abrir la ventana con el n√∫mero y el texto
            window.open(`https://wa.me/${whatsappNumber}?text=${whatsappText}`, '_blank');
        };
        // FIN CORRECCI√ìN

        window.handleManualSale = async () => {
            const name = document.getElementById('manual-sale-product-name').value;
            const qty = parseInt(document.getElementById('manual-sale-quantity').value);
            const price = parseFloat(document.getElementById('manual-sale-price').value);
            const client = document.getElementById('manual-sale-client-name').value;
            const deduct = document.getElementById('manual-sale-deduct-stock').checked;
            const pay = document.getElementById('manual-sale-payment').value;

            // Usar window.alert en lugar de alert()
            if(!name || !qty || !price) return window.alert('Faltan datos');
            
            if(deduct) {
                const p = productData.find(x => x.nombre.toLowerCase() === name.toLowerCase());
                if(p) await updateDoc(doc(db, "products", p.id), {stock: p.stock - qty});
            }
            await addDoc(collection(db, "ventas"), { 
                fecha_venta: new Date().toLocaleDateString(), 
                cliente_nombre: client, 
                items: [{nombre: name, cantidad: qty, precio: price}], 
                total_final: price * qty,
                metodo_pago: pay
            });
            showToast("Venta registrada"); closeManualSaleModal();
        };
        
        document.getElementById('confirm-sale-button').onclick = async () => {
             // Reemplazamos window.confirm por el modal personalizado para confirmar la venta.
             if(Object.keys(cart).length === 0) return window.alert("Carrito vac√≠o");
             
             openConfirmationModal(
                 "Confirmar Venta",
                 "¬øConfirmas esta venta y deseas descontar el stock de los productos?",
                 async () => {
                     const client = document.getElementById('client-name').value || 'Cliente';
                     const whatsapp = document.getElementById('whatsapp-number').value;
                     const pay = document.getElementById('payment-method').value;
                     const disc = parseFloat(document.getElementById('discount-select').value);
                     
                     let total = 0;
                     const items = [];
                     const batch = writeBatch(db);
                     let stockError = false;
                     
                     for(let id in cart) {
                         const item = cart[id];
                         const p = productData.find(x => x.id === id);
                         if(p) {
                             const newStock = p.stock - item.cantidad;
                             // Usar window.alert en lugar de alert()
                             if(newStock < 0) { 
                                 window.alert(`No hay stock suficiente de ${p.nombre}`); 
                                 stockError = true;
                                 break; 
                             }
                             batch.update(doc(db, "products", id), {stock: newStock});
                             items.push({nombre: item.nombre, cantidad: item.cantidad, precio_unitario: item.precio});
                             total += item.precio * item.cantidad;
                         }
                     }

                     if(stockError) return;
                     
                     await batch.commit();
                     
                     await addDoc(collection(db, "ventas"), {
                         fecha_venta: new Date().toLocaleDateString(),
                         cliente_nombre: client,
                         cliente_whatsapp: whatsapp,
                         metodo_pago: pay,
                         total_final: total * (1-disc),
                         descuento_aplicado: disc,
                         items: items
                     });
                     
                     showToast("Venta exitosa!");
                     cart = {}; saveCart(); renderCart();
                 }
             );
        };

        const pendingList = document.getElementById('pending-list');
        onSnapshot(collection(db, "pending_orders"), (snap) => {
            pendingList.innerHTML = '';
            if(snap.empty) pendingList.innerHTML = '<p class="text-stone-500 text-center">Sin pendientes.</p>';
            snap.forEach(d => {
                const o = d.data();
                const div = document.createElement('div');
                div.className = 'bg-stone-50 p-2 border rounded mb-2 flex justify-between text-sm';
                div.innerHTML = `<span>${o.cliente_nombre} (${formatCurrency(o.total_estimado)})</span>`;
                
                const btnContainer = document.createElement('div');
                btnContainer.className = 'flex gap-2';
                
                // Bot√≥n Cargar - Usamos modal de confirmaci√≥n
                const loadBtn = document.createElement('button'); 
                loadBtn.className = 'text-blue-600 font-bold hover:underline'; 
                loadBtn.textContent = 'Cargar';
                loadBtn.onclick = () => {
                    openConfirmationModal(
                        "Cargar Pedido Pendiente",
                        `¬øDeseas reemplazar la cotizaci√≥n actual con el pedido de ${o.cliente_nombre}?`,
                        () => {
                            cart = o.cart; 
                            document.getElementById('client-name').value = o.cliente_nombre; 
                            saveCart(); 
                            renderCart();
                            showToast("Pedido cargado");
                        }
                    );
                };

                // Bot√≥n Eliminar - Usamos modal de confirmaci√≥n (FIX PRINCIPAL)
                const del = document.createElement('button'); 
                del.className = 'text-red-600 hover:text-red-800'; 
                del.textContent = 'üóëÔ∏è';
                del.onclick = () => {
                    openConfirmationModal(
                        "Eliminar Pendiente",
                        `¬øEst√°s seguro de eliminar el pedido pendiente de ${o.cliente_nombre}? Esta acci√≥n no se puede deshacer.`,
                        () => {
                            deleteDoc(doc(db, "pending_orders", d.id));
                            showToast("Pedido eliminado");
                        }
                    );
                };
                
                btnContainer.appendChild(loadBtn);
                btnContainer.appendChild(del);
                
                div.appendChild(btnContainer); 
                pendingList.appendChild(div);
            });
        });

        document.getElementById('save-pending-button').onclick = async () => {
            if(Object.keys(cart).length === 0) return showToast("Carrito vac√≠o");
            const client = document.getElementById('client-name').value || 'Sin nombre';
            const disc = parseFloat(document.getElementById('discount-select').value);
            let total = 0; for(let k in cart) total += cart[k].precio * cart[k].cantidad;
            await addDoc(collection(db, "pending_orders"), { timestamp: new Date(), cliente_nombre: client, cart: cart, total_estimado: total * (1-disc) });
            showToast("Guardado en pendientes"); cart = {}; saveCart(); renderCart();
        };

        window.showView = (v) => { const isCat = v === 'catalog'; document.getElementById('catalog-panel').style.display = isCat ? 'block' : 'none'; document.getElementById('cart-panel').style.display = isCat ? 'none' : 'flex'; };
        loadCart();
    </script>
</body>
</html>
