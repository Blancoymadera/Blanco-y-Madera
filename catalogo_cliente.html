<!DOCTYPE html>
<html lang="es">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Blanco & Madera</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fdfbf7;
            color: #44403c;
            -webkit-tap-highlight-color: transparent;
        }

        h1, h2, h3, .font-serif { font-family: 'Playfair Display', serif; }

        /* Layout & Utils */
        .sidebar { width: 260px; transition: transform 0.3s ease-in-out; }
        .view-section { display: none; animation: fadeIn 0.4s ease-out; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        /* Cards & Interactions */
        .product-card { transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); cursor: pointer; }
        .product-card:hover { transform: translateY(-4px); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
        .fav-btn.active i { color: #ef4444; font-weight: 900; animation: heartPop 0.3s; }
        @keyframes heartPop { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }

        /* Thumbnails */
        .thumbnail { transition: all 0.2s; border: 2px solid transparent; }
        .thumbnail.active { border-color: #d97706; transform: scale(0.95); }

        /* Loader */
        .loader-dots div { animation: loader-dots 0.6s infinite cubic-bezier(0, 1, 1, 0); }
        .loader-dots div:nth-child(1) { left: 8px; animation-delay: -0.24s; }
        .loader-dots div:nth-child(2) { left: 32px; animation-delay: -0.12s; }
        .loader-dots div:nth-child(3) { left: 56px; animation-delay: 0; }
        @keyframes loader-dots { 0% { top: 8px; height: 64px; } 50%, 100% { top: 24px; height: 32px; } }
    </style>
</head>
<body class="h-screen flex overflow-hidden bg-[#fdfbf7]">

    <!-- SIDEBAR (Escritorio) -->
    <aside class="sidebar hidden md:flex flex-col bg-white border-r border-stone-200 h-full z-30">
        <div class="p-8 text-center">
            <h1 class="text-2xl font-bold text-stone-800">blanco&madera</h1>
            <p class="text-[10px] tracking-[0.3em] text-stone-500 mt-1 uppercase">Deco Home</p>
        </div>

        <nav class="flex-grow px-4 space-y-2">
            <button onclick="navigate('home')" class="nav-item w-full flex items-center gap-4 px-4 py-3 text-stone-600 rounded-xl hover:bg-stone-50 hover:text-amber-600 transition font-medium text-left" data-target="home">
                <i class="fa-solid fa-house text-lg w-6 text-center"></i> Inicio
            </button>
            <button onclick="navigate('products')" class="nav-item w-full flex items-center gap-4 px-4 py-3 text-stone-600 rounded-xl hover:bg-stone-50 hover:text-amber-600 transition font-medium text-left" data-target="products">
                <i class="fa-solid fa-shop text-lg w-6 text-center"></i> Productos
            </button>
             <button onclick="navigate('favorites')" class="nav-item w-full flex items-center gap-4 px-4 py-3 text-stone-600 rounded-xl hover:bg-stone-50 hover:text-amber-600 transition font-medium text-left" data-target="favorites">
                <i class="fa-solid fa-heart text-lg w-6 text-center"></i> Favoritos
            </button>
            <button onclick="navigate('about')" class="nav-item w-full flex items-center gap-4 px-4 py-3 text-stone-600 rounded-xl hover:bg-stone-50 hover:text-amber-600 transition font-medium text-left" data-target="about">
                <i class="fa-solid fa-store text-lg w-6 text-center"></i> Nosotros
            </button>
        </nav>

        <div class="p-6 border-t border-stone-100">
            <button onclick="openCartModal()" class="w-full bg-stone-900 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-stone-800 transition flex items-center justify-center gap-2">
                <i class="fa-solid fa-cart-shopping"></i> Carrito 
                <span id="sidebar-cart-count" class="bg-amber-500 text-white text-xs px-2 py-0.5 rounded-full hidden">0</span>
            </button>
        </div>
    </aside>

    <!-- CONTENIDO PRINCIPAL -->
    <div class="flex-1 flex flex-col h-full relative overflow-hidden">
        
        <!-- Header M√≥vil -->
        <header class="md:hidden bg-white/90 backdrop-blur-sm border-b border-stone-100 p-4 flex justify-between items-center sticky top-0 z-20">
            <h1 class="text-xl font-bold text-stone-800 leading-none font-serif">blanco&madera</h1>
            <div class="flex gap-4">
                <button onclick="navigate('favorites')" class="text-stone-600 relative">
                    <i class="fa-regular fa-heart text-xl"></i>
                </button>
                <button onclick="openCartModal()" class="relative text-stone-800">
                    <i class="fa-solid fa-cart-shopping text-xl"></i>
                    <span id="mobile-cart-badge" class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white text-[10px] font-bold rounded-full flex items-center justify-center hidden">0</span>
                </button>
            </div>
        </header>

        <main id="main-scroll" class="flex-1 overflow-y-auto scroll-smooth pb-24 md:pb-0">
            
            <!-- === VISTA: INICIO === -->
            <section id="view-home" class="view-section active">
                <!-- Hero Banner -->
                <div class="relative bg-stone-200 h-72 md:h-96 flex items-center justify-center overflow-hidden">
                    <img src="https://images.unsplash.com/photo-1616486338812-3dadae4b4ace?q=80&w=1932&auto=format&fit=crop" class="absolute inset-0 w-full h-full object-cover opacity-70" alt="Banner">
                    <div class="absolute inset-0 bg-gradient-to-t from-stone-900/40 to-transparent"></div>
                    <div class="relative z-10 text-center px-4 animate-[fadeIn_0.8s_ease-out]">
                        <h2 class="text-4xl md:text-6xl font-bold text-white mb-3 drop-shadow-lg font-serif">Renov√° tu Hogar</h2>
                        <p class="text-stone-100 text-lg md:text-xl mb-8 font-medium drop-shadow-md">Detalles √∫nicos que transforman espacios.</p>
                        <button onclick="navigate('products')" class="bg-white text-stone-900 px-8 py-3 rounded-full font-bold shadow-xl hover:bg-amber-50 transition transform hover:scale-105">
                            Ver Cat√°logo
                        </button>
                    </div>
                </div>

                <!-- Categor√≠as Visuales -->
                <div class="container mx-auto px-4 py-10 max-w-6xl">
                    <h3 class="text-2xl font-bold text-stone-800 mb-6 font-serif">Nuestras Categor√≠as</h3>
                    <div id="categories-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
                        <!-- JS llena esto -->
                    </div>
                </div>

                <!-- Destacados -->
                <div class="bg-white py-12">
                    <div class="container mx-auto px-4 max-w-6xl">
                        <div class="flex justify-between items-end mb-8">
                            <h3 class="text-2xl font-bold text-stone-800 font-serif">Destacados</h3>
                            <button onclick="navigate('products')" class="text-amber-600 font-semibold text-sm hover:underline">Ver todo</button>
                        </div>
                        <div id="featured-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="col-span-full text-center py-8 text-stone-400"><i class="fa-solid fa-circle-notch fa-spin"></i> Cargando...</div>
                        </div>
                    </div>
                </div>

                <!-- Info -->
                <div class="container mx-auto px-4 py-12 max-w-4xl text-center grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="p-4"><i class="fa-solid fa-truck text-3xl text-amber-600 mb-3"></i><h4 class="font-bold text-stone-800">Env√≠os Pa√≠s</h4><p class="text-sm text-stone-500">Llegamos a tu casa</p></div>
                    <div class="p-4"><i class="fa-regular fa-credit-card text-3xl text-amber-600 mb-3"></i><h4 class="font-bold text-stone-800">Pagos</h4><p class="text-sm text-stone-500">Efectivo, Transferencia, Tarjeta</p></div>
                    <div class="p-4"><i class="fa-brands fa-whatsapp text-3xl text-amber-600 mb-3"></i><h4 class="font-bold text-stone-800">Asesoramiento</h4><p class="text-sm text-stone-500">Escribinos tus dudas</p></div>
                </div>
            </section>

            <!-- === VISTA: PRODUCTOS === -->
            <section id="view-products" class="view-section">
                <!-- Barra Filtros Sticky -->
                <div class="bg-white sticky top-0 z-20 shadow-sm px-4 py-3 border-b border-stone-100">
                    <div class="container mx-auto max-w-5xl flex flex-col md:flex-row gap-3">
                        <div class="relative flex-grow">
                            <i class="fa-solid fa-magnifying-glass absolute left-3 top-3.5 text-stone-400"></i>
                            <input type="text" id="client-search" placeholder="Buscar productos..." class="w-full pl-10 pr-4 py-3 rounded-xl bg-stone-50 border-none focus:ring-2 focus:ring-amber-500/20 text-stone-700">
                        </div>
                        <div class="flex gap-2">
                            <select id="client-category-filter" class="rounded-xl bg-stone-50 border-none text-sm font-medium text-stone-600 px-3 py-3 cursor-pointer focus:ring-2 focus:ring-amber-500/20 truncate max-w-[140px]">
                                <option value="all">Categor√≠a: Todas</option>
                            </select>
                            <select id="client-sort-filter" class="rounded-xl bg-stone-50 border-none text-sm font-medium text-stone-600 px-3 py-3 cursor-pointer focus:ring-2 focus:ring-amber-500/20">
                                <option value="default">Ordenar</option>
                                <option value="price-asc">Menor Precio</option>
                                <option value="price-desc">Mayor Precio</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="container mx-auto px-4 py-6 max-w-6xl min-h-[60vh]">
                    <div id="products-container" class="space-y-8"></div> <!-- Grid o mensaje -->
                    <div id="loading-catalog" class="flex flex-col items-center py-20">
                        <div class="loader-dots block relative w-20 h-5"><div class="bg-amber-500 absolute top-0 w-3 h-3 rounded-full"></div><div class="bg-amber-500 absolute top-0 w-3 h-3 rounded-full"></div><div class="bg-amber-500 absolute top-0 w-3 h-3 rounded-full"></div><div class="bg-amber-500 absolute top-0 w-3 h-3 rounded-full"></div></div>
                    </div>
                </div>
            </section>

            <!-- === VISTA: FAVORITOS === -->
             <section id="view-favorites" class="view-section">
                <div class="container mx-auto px-4 py-8 max-w-6xl min-h-[60vh]">
                    <h2 class="text-2xl font-bold text-stone-800 mb-6 font-serif">Mis Favoritos ‚ù§Ô∏è</h2>
                    <div id="favorites-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6">
                        <!-- Se llena con JS -->
                    </div>
                    <div id="no-favorites" class="hidden text-center py-20">
                        <div class="text-6xl mb-4">üíî</div>
                        <p class="text-stone-500 mb-4">A√∫n no guardaste ning√∫n favorito.</p>
                        <button onclick="navigate('products')" class="bg-stone-900 text-white px-6 py-2 rounded-full text-sm font-bold">Explorar Productos</button>
                    </div>
                </div>
            </section>

            <!-- === VISTA: NOSOTROS === -->
            <section id="view-about" class="view-section">
                <div class="container mx-auto px-4 py-12 max-w-2xl text-center">
                    <h2 class="text-3xl font-bold text-stone-800 mb-6 font-serif">Nuestra Historia</h2>
                    <div class="bg-white p-8 rounded-2xl shadow-sm border border-stone-100">
                        <p class="text-stone-600 leading-relaxed mb-4">
                            En <strong>Blanco & Madera</strong> creemos que cada hogar tiene una historia que contar. Nacimos con la pasi√≥n de crear espacios c√°lidos y acogedores a trav√©s de detalles simples pero significativos.
                        </p>
                        <div class="my-8 h-px bg-stone-100 w-1/2 mx-auto"></div>
                        <p class="text-stone-600 leading-relaxed">
                            Gracias por elegirnos para formar parte de tu hogar.
                        </p>
                    </div>
                </div>
            </section>

            <footer class="bg-stone-900 text-stone-400 py-8 mt-auto text-center text-xs">
                <p>&copy; 2025 Blanco & Madera</p>
            </footer>
        </main>

        <!-- NAV M√ìVIL -->
        <nav class="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-stone-200 px-6 py-2 flex justify-between items-center z-40 pb-safe">
            <button onclick="navigate('home')" class="nav-icon flex flex-col items-center gap-1 p-2 text-amber-600" data-target="home"><i class="fa-solid fa-house text-xl"></i><span class="text-[10px] font-bold">Inicio</span></button>
            <button onclick="navigate('products')" class="nav-icon flex flex-col items-center gap-1 p-2 text-stone-400" data-target="products"><i class="fa-solid fa-shop text-xl"></i><span class="text-[10px] font-bold">Cat√°logo</span></button>
            <button onclick="navigate('about')" class="nav-icon flex flex-col items-center gap-1 p-2 text-stone-400" data-target="about"><i class="fa-solid fa-store text-xl"></i><span class="text-[10px] font-bold">Nosotros</span></button>
        </nav>
    </div>

    <!-- MODAL VISTA R√ÅPIDA (CON GALER√çA Y SELECCI√ìN DE VARIANTE) -->
    <div id="quickview-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-stone-900/70 backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden relative animate-[scaleIn_0.3s_ease-out] flex flex-col max-h-[90vh]">
            <button onclick="closeModal('quickview-modal')" class="absolute top-3 right-3 z-10 bg-white/90 rounded-full p-2 text-stone-500 hover:text-stone-900 shadow-sm"><i class="fa-solid fa-xmark text-lg"></i></button>
            
            <!-- Imagen Principal -->
            <div class="h-64 bg-white flex items-center justify-center p-4 shrink-0">
                <img id="qv-image" src="" class="max-w-full max-h-full object-contain" alt="Producto">
            </div>

            <!-- Galer√≠a Miniaturas (se llena si hay fotos) -->
            <div id="qv-thumbnails" class="px-4 pb-2 flex gap-2 overflow-x-auto hide-scroll shrink-0 h-16"></div>
            
            <div class="p-6 bg-white overflow-y-auto">
                <span id="qv-category" class="text-[10px] font-bold tracking-widest text-amber-600 uppercase bg-amber-50 px-2 py-1 rounded-md"></span>
                <h3 id="qv-name" class="text-xl font-bold text-stone-800 mt-2 leading-tight"></h3>
                
                <div class="my-4 flex items-baseline justify-between border-b border-stone-100 pb-4">
                    <span id="qv-price" class="text-3xl font-extrabold text-stone-900"></span>
                    <div id="qv-stock-status"></div>
                </div>

                <!-- SELECTOR DE VARIANTES (DESPLEGABLE) -->
                <div id="variants-container" class="mb-5 hidden">
                    <label class="block text-xs font-bold text-stone-500 uppercase mb-2">Elige una opci√≥n:</label>
                    <!-- AQUI EST√Å EL SELECT QUE PEDISTE -->
                    <select id="variant-select" class="w-full border border-stone-200 rounded-lg p-3 text-sm focus:ring-2 focus:ring-amber-400 outline-none bg-stone-50 cursor-pointer">
                        <option value="">Seleccionar...</option>
                    </select>
                </div>

                <!-- Input Manual (fallback) -->
                <div id="manual-variant-container" class="mb-4">
                    <label for="qv-variant" class="block text-xs font-bold text-stone-500 uppercase mb-1">Preferencia (Opcional)</label>
                    <input type="text" id="qv-variant" class="w-full border border-stone-200 rounded-lg p-2 text-sm focus:ring-2 focus:ring-amber-400 outline-none" placeholder="Ej: Aroma, Color...">
                </div>

                <button id="qv-add-btn" class="w-full bg-stone-900 text-white font-bold py-3.5 rounded-xl shadow-lg hover:bg-stone-800 active:scale-95 transition flex items-center justify-center gap-2 text-lg">
                    <span>Agregar al Carrito</span>
                </button>

                <!-- Relacionados -->
                <div class="mt-6 pt-4 border-t border-stone-100">
                    <p class="text-xs font-bold text-stone-400 uppercase mb-3">Tambi√©n te puede interesar</p>
                    <div id="qv-related" class="grid grid-cols-2 gap-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL CARRITO -->
    <div id="cart-modal" class="fixed inset-0 z-50 hidden items-end sm:items-center justify-center p-0 sm:p-4 bg-stone-900/60 backdrop-blur-sm">
        <div class="bg-white w-full sm:max-w-md sm:rounded-2xl rounded-t-2xl shadow-2xl h-[85vh] sm:h-auto flex flex-col animate-[slideUp_0.3s_ease-out]">
            <div class="p-5 border-b flex justify-between items-center bg-stone-50 sm:rounded-t-2xl"><h3 class="font-bold text-stone-800">Tu Pedido</h3><button onclick="closeModal('cart-modal')" class="text-stone-400"><i class="fa-solid fa-xmark text-xl"></i></button></div>
            <div id="cart-items-container" class="flex-grow overflow-y-auto p-5 space-y-4"></div>
            <div class="p-5 bg-white border-t shadow-lg z-10"><div class="flex justify-between mb-4"><span class="text-stone-500">Total</span><span id="cart-total-price" class="text-2xl font-extrabold">$0</span></div><button onclick="goToCheckout()" id="btn-checkout" class="w-full bg-green-600 text-white font-bold py-3.5 rounded-xl">Continuar</button></div>
        </div>
    </div>

    <div id="checkout-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-stone-900/60 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-8 animate-[scaleIn_0.3s]">
            <div class="text-center mb-6"><div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3 text-green-600 text-2xl"><i class="fa-brands fa-whatsapp"></i></div><h3 class="text-2xl font-bold">¬°Casi listo!</h3></div>
            <div class="space-y-4"><label class="text-xs font-bold text-stone-500 uppercase">Tu Nombre</label><input type="text" id="customer-name" class="w-full border rounded-xl p-3 bg-stone-50"></div>
            <div class="flex gap-3 mt-8"><button onclick="closeModal('checkout-modal')" class="flex-1 py-3 font-bold text-stone-400">Volver</button><button onclick="finalizeOrder()" class="flex-[2] bg-green-600 text-white font-bold py-3 rounded-xl shadow-lg">Enviar Pedido</button></div>
        </div>
    </div>

    <div id="toast-container" class="fixed top-4 left-1/2 -translate-x-1/2 z-[70] pointer-events-none flex flex-col gap-2 w-full px-4 items-center"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const CONFIG = {
            whatsappNumber: "5493415550000", // ‚ö†Ô∏è TU N√öMERO AQU√ç
            firebase: {
                apiKey: "",
                authDomain: "blanco-y-madera-17214.firebaseapp.com",
                projectId: "blanco-y-madera-17214",
                storageBucket: "blanco-y-madera-17214.appspot.com",
                messagingSenderId: "147976695842",
                appId: "1:147976695842:web:e165092b1fee5aa1e99a7b"
            }
        };

        const app = initializeApp(CONFIG.firebase);
        const db = getFirestore(app);

        let allProducts = [];
        let cart = JSON.parse(localStorage.getItem('bm_client_cart')) || {};
        let favorites = JSON.parse(localStorage.getItem('bm_client_favs')) || [];
        let categories = new Set();
        let currentSelectedVariant = null; 

        // --- NAVEGACI√ìN ---
        window.navigate = (viewId) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${viewId}`).classList.add('active');
            document.getElementById('main-scroll').scrollTop = 0;

            const updateNav = (selector, activeClass, inactiveClass) => {
                document.querySelectorAll(selector).forEach(btn => {
                    const isActive = btn.dataset.target === viewId;
                    btn.classList.toggle(activeClass, isActive);
                    if(inactiveClass) btn.classList.toggle(inactiveClass, !isActive);
                });
            };
            
            updateNav('.sidebar .nav-item', 'text-amber-600', 'text-stone-600'); 
            updateNav('nav.md\\:hidden .nav-icon', 'text-amber-600', 'text-stone-400');

            if(viewId === 'favorites') renderFavorites();
        };

        // --- FIREBASE ---
        onSnapshot(collection(db, "products"), (snapshot) => {
            allProducts = [];
            categories = new Set();
            snapshot.forEach(doc => {
                const d = doc.data();
                
                // LOGICA MULTIPLE IMAGEN
                let imagesList = [];
                if(d.images && Array.isArray(d.images)) imagesList = d.images;
                
                // COVER: Usar imageUrl/ImageUrl expl√≠cito si existe, sino la primera de la lista
                let coverImg = d.imageUrl || d.ImageUrl;
                if (!coverImg && imagesList.length > 0) coverImg = imagesList[0];
                if (!coverImg && !imagesList.length) coverImg = null;

                // LOGICA VARIANTES
                let variantsList = [];
                if (d.variants && Array.isArray(d.variants)) variantsList = d.variants;
                else if (d.opciones && Array.isArray(d.opciones)) variantsList = d.opciones;

                allProducts.push({
                    id: doc.id,
                    nombre: d.nombre || "Producto",
                    categoria: d.categoria || "Varios",
                    precio: Number(d.precio) || 0,
                    stock: Number(d.stock) || 0,
                    images: imagesList, 
                    imageUrl: coverImg,
                    variants: variantsList
                });
                if(d.categoria) categories.add(d.categoria);
            });

            initFilters();
            renderCategoryCards(); 
            renderFeatured();      
            renderProductsGrid();  
            updateCartUI();
            
            document.getElementById('loading-catalog').classList.add('hidden');
            if(document.getElementById('loading-state')) document.getElementById('loading-state').style.display = 'none'; 
        }, (err) => console.error(err));

        // --- HOME: CATEGOR√çAS VISUALES ---
        function renderCategoryCards() {
            const grid = document.getElementById('categories-grid');
            grid.innerHTML = '';
            Array.from(categories).sort().forEach(cat => {
                const p = allProducts.find(x => x.categoria === cat && x.imageUrl);
                const img = p ? p.imageUrl : 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZTZlNmU2IiBzdHJva2Utd2lkdGg9IjEiPjxyZWN0IHg9IjMiIHk9IjMiIHdpZHRoPSIxOCIgaGVpZ2h0PSIxOCIgcng9IjIiIHJ5PSIyIi8+PC9zdmc+';
                
                const btn = document.createElement('div');
                btn.className = 'group cursor-pointer';
                btn.onclick = () => {
                    document.getElementById('client-category-filter').value = cat;
                    navigate('products');
                    filterProducts();
                };
                btn.innerHTML = `
                    <div class="h-24 rounded-xl overflow-hidden mb-2 border border-stone-100 relative">
                        <img src="${img}" class="w-full h-full object-cover transition duration-500 group-hover:scale-110">
                        <div class="absolute inset-0 bg-black/10 group-hover:bg-transparent transition"></div>
                    </div>
                    <p class="text-center text-xs font-bold text-stone-700 group-hover:text-amber-700">${cat}</p>
                `;
                grid.appendChild(btn);
            });
        }

        // --- RENDERIZADO GEN√âRICO ---
        function renderGrid(products, containerId) {
            const grid = document.getElementById(containerId);
            grid.innerHTML = '';
            if(products.length === 0 && containerId === 'products-container') {
                grid.innerHTML = '<div class="col-span-full text-center py-10 text-stone-400">Sin resultados</div>'; return;
            }
            products.forEach(p => grid.appendChild(createCard(p)));
        }

        function renderProductsGrid() { renderGrid(allProducts, 'products-container'); }
        function renderFeatured() { renderGrid(allProducts.filter(p => p.imageUrl && p.stock>0).slice(0,4), 'featured-grid'); }
        
        function renderFavorites() {
            const favProducts = allProducts.filter(p => favorites.includes(p.id));
            const grid = document.getElementById('favorites-grid');
            const empty = document.getElementById('no-favorites');
            
            if(favProducts.length === 0) {
                grid.innerHTML = ''; grid.style.display = 'none'; empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden'); grid.style.display = 'grid';
                renderGrid(favProducts, 'favorites-grid');
            }
        }

        // --- TARJETA DE PRODUCTO ---
        function createCard(p) {
            const div = document.createElement('div');
            const isFav = favorites.includes(p.id);
            const img = p.imageUrl || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZTZlNmU2IiBzdHJva2Utd2lkdGg9IjEiPjxyZWN0IHg9IjMiIHk9IjMiIHdpZHRoPSIxOCIgaGVpZ2h0PSIxOCIgcng9IjIiIHJ5PSIyIi8+PC9zdmc+';
            const stock = p.stock > 0;

            // Ajuste clave: aspect-square para forzar 1:1 en el contenedor de la imagen
            div.className = 'bg-white rounded-xl border border-stone-100 shadow-sm product-card overflow-hidden relative group h-full flex flex-col';
            div.innerHTML = `
                <button class="fav-btn absolute top-2 right-2 z-10 w-8 h-8 bg-white/90 rounded-full shadow flex items-center justify-center text-stone-300 hover:text-red-500 transition ${isFav?'active':''}" onclick="event.stopPropagation(); toggleFav('${p.id}', this)">
                    <i class="fa-solid fa-heart"></i>
                </button>
                <div class="aspect-square w-full p-3 flex items-center justify-center relative bg-white">
                    <img src="${img}" class="max-w-full max-h-full object-contain transition duration-500 group-hover:scale-105">
                    ${!stock ? '<span class="absolute bottom-2 left-2 bg-stone-100 text-stone-400 text-[10px] font-bold px-2 rounded">AGOTADO</span>' : ''}
                    ${(p.images && p.images.length > 0) ? '<span class="absolute bottom-2 right-2 bg-black/50 text-white text-[10px] px-1.5 rounded"><i class="fa-regular fa-images"></i></span>' : ''}
                </div>
                <div class="p-3 border-t border-stone-50 flex flex-col flex-grow">
                    <p class="text-[10px] text-amber-600 font-bold uppercase mb-1 truncate">${p.categoria}</p>
                    <h3 class="font-bold text-stone-800 text-sm leading-tight mb-auto line-clamp-2">${p.nombre}</h3>
                    <div class="flex justify-between items-end mt-2">
                        <span class="font-extrabold text-stone-900">$${p.precio.toLocaleString('es-AR')}</span>
                        <button class="w-8 h-8 rounded-full ${stock ? 'bg-amber-50 text-amber-700 hover:bg-amber-500 hover:text-white' : 'bg-stone-100 text-stone-300'} flex items-center justify-center transition shadow-sm text-xs" onclick="event.stopPropagation(); ${stock ? `openQuickViewById('${p.id}')` : ''}">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>
                </div>
            `;
            div.onclick = (e) => { if(!e.target.closest('button')) openQuickView(p); };
            return div;
        }

        window.openQuickViewById = (id) => {
             const p = allProducts.find(x => x.id === id);
             if(p) openQuickView(p);
        }

        window.toggleFav = (id, btn) => {
            if(favorites.includes(id)) {
                favorites = favorites.filter(fid => fid !== id);
                btn.classList.remove('active');
                showToast('Eliminado de favoritos');
            } else {
                favorites.push(id);
                btn.classList.add('active');
                showToast('¬°Guardado en favoritos!');
            }
            localStorage.setItem('bm_client_favs', JSON.stringify(favorites));
            if(document.getElementById('view-favorites').classList.contains('active')) renderFavorites();
        };

        // --- FILTROS ---
        function initFilters() {
            const selCat = document.getElementById('client-category-filter');
            const selSort = document.getElementById('client-sort-filter');
            const search = document.getElementById('client-search');

            selCat.innerHTML = '<option value="all">Categor√≠a: Todas</option>';
            Array.from(categories).sort().forEach(c => selCat.innerHTML += `<option value="${c}">${c}</option>`);

            [selCat, selSort, search].forEach(el => el.addEventListener(el.tagName==='INPUT'?'input':'change', filterProducts));
        }

        function filterProducts() {
            const cat = document.getElementById('client-category-filter').value;
            const sort = document.getElementById('client-sort-filter').value;
            const term = document.getElementById('client-search').value.toLowerCase();

            let res = allProducts.filter(p => {
                const mCat = cat === 'all' || p.categoria === cat;
                const mName = p.nombre.toLowerCase().includes(term);
                return mCat && mName;
            });

            if(sort === 'price-asc') res.sort((a,b) => a.precio - b.precio);
            if(sort === 'price-desc') res.sort((a,b) => b.precio - a.precio);

            renderGrid(res, 'products-container');
        }

        // --- MODAL DETALLE (GALERIA Y DESPLEGABLE DE VARIANTES) ---
        window.openQuickView = (p) => {
            const m = document.getElementById('quickview-modal');
            const btn = document.getElementById('qv-add-btn');
            const mainImg = document.getElementById('qv-image');
            const thumbs = document.getElementById('qv-thumbnails');
            const variantsContainer = document.getElementById('variants-container');
            const variantSelect = document.getElementById('variant-select');
            const manualInput = document.getElementById('manual-variant-container');
            
            // Reset state
            currentSelectedVariant = null;
            document.getElementById('qv-variant').value = '';
            variantSelect.innerHTML = '<option value="">Seleccionar...</option>';

            // Info base
            document.getElementById('qv-category').textContent = p.categoria;
            document.getElementById('qv-name').textContent = p.nombre;
            document.getElementById('qv-price').textContent = `$${p.precio.toLocaleString('es-AR')}`;
            
            // Galer√≠a
            mainImg.src = p.imageUrl || 'data:image/svg+xml;base64,PHN2Zy...';
            thumbs.innerHTML = '';
            
            // Si hay una lista de im√°genes (variantes), se usa para la galer√≠a.
            // Si NO hay lista 'images' pero s√≠ hay foto de portada, la usamos como √∫nica foto.
            let galleryImages = [];
            if (p.images && p.images.length > 0) {
                galleryImages = p.images;
            } else if (p.imageUrl) {
                galleryImages = [p.imageUrl];
            }

            if(galleryImages.length > 1) {
                galleryImages.forEach((img, idx) => {
                    const t = document.createElement('img');
                    t.src = img;
                    t.className = 'w-12 h-12 object-contain border border-stone-200 rounded cursor-pointer hover:border-amber-500 thumbnail';
                    t.onclick = () => {
                        mainImg.src = img;
                        document.querySelectorAll('.thumbnail').forEach(el => el.classList.remove('active'));
                        t.classList.add('active');
                        
                        // Al hacer clic en miniatura, intentar seleccionar variante si hay coincidencia por √≠ndice
                        if (p.variants && p.variants[idx]) {
                             variantSelect.selectedIndex = idx + 1; // +1 porque el 0 es "Seleccionar..."
                             currentSelectedVariant = p.variants[idx];
                        }
                    };
                    thumbs.appendChild(t);
                });
                thumbs.firstChild.classList.add('active');
            }

            // Variantes (Dropdown SELECT)
            if (p.variants && p.variants.length > 0) {
                variantsContainer.classList.remove('hidden');
                manualInput.classList.add('hidden'); // Ocultar input manual
                
                p.variants.forEach((v, idx) => {
                    const opt = document.createElement('option');
                    opt.value = v;
                    opt.textContent = v;
                    variantSelect.appendChild(opt);
                });

                // Evento de cambio en el select
                variantSelect.onchange = (e) => {
                    const selectedVal = e.target.value;
                    const idx = p.variants.indexOf(selectedVal);
                    
                    currentSelectedVariant = selectedVal;

                    // Cambiar foto si hay coincidencia en el array de im√°genes
                    if (idx >= 0 && p.images && p.images[idx]) {
                         mainImg.src = p.images[idx];
                         document.querySelectorAll('.thumbnail').forEach(el => el.classList.remove('active'));
                         if(thumbs.children[idx]) thumbs.children[idx].classList.add('active');
                    }
                };

            } else {
                variantsContainer.classList.add('hidden');
                manualInput.classList.remove('hidden');
            }

            // Stock
            const stock = document.getElementById('qv-stock-status');
            if(p.stock <= 0) {
                stock.innerHTML = '<span class="text-red-500 font-medium text-sm">Sin Stock</span>';
                btn.disabled = true; btn.classList.add('opacity-50');
            } else {
                stock.innerHTML = '<span class="text-green-600 font-medium text-sm">Disponible</span>';
                btn.disabled = false; btn.classList.remove('opacity-50');
                btn.onclick = () => { addToCart(p.id); };
            }

            // Relacionados
            const rel = document.getElementById('qv-related');
            rel.innerHTML = '';
            const related = allProducts.filter(x => x.categoria === p.categoria && x.id !== p.id).slice(0, 2);
            if(related.length > 0) {
                related.forEach(r => {
                    const rDiv = document.createElement('div');
                    rDiv.className = 'bg-stone-50 rounded-lg p-2 flex items-center gap-2 cursor-pointer hover:bg-stone-100';
                    rDiv.onclick = () => openQuickView(r);
                    rDiv.innerHTML = `
                        <img src="${r.imageUrl || ''}" class="w-10 h-10 object-contain bg-white rounded border border-stone-100">
                        <div class="truncate text-xs font-bold text-stone-700 flex-1">${r.nombre}</div>
                        <div class="text-xs font-bold text-amber-700">$${r.precio}</div>
                    `;
                    rel.appendChild(rDiv);
                });
            } else {
                rel.innerHTML = '<span class="text-xs text-stone-400">No hay productos relacionados.</span>';
            }

            m.classList.remove('hidden'); m.classList.add('flex');
        };


        // --- CARRITO ---
        function addToCart(id) {
            const p = allProducts.find(x => x.id === id);
            if(!p) return;
            
            let variant = "";
            const hasVariantsConfigured = p.variants && p.variants.length > 0;

            // Validaci√≥n: Si hay variantes (select), ES OBLIGATORIO elegir una
            if (hasVariantsConfigured) {
                if (!currentSelectedVariant && !document.getElementById('quickview-modal').classList.contains('hidden')) {
                    showToast("‚ö†Ô∏è Por favor, elige una opci√≥n");
                    // Resaltar el select
                    const sel = document.getElementById('variant-select');
                    sel.classList.add('ring-2', 'ring-red-500');
                    setTimeout(() => sel.classList.remove('ring-2', 'ring-red-500'), 1000);
                    return;
                }
                if (currentSelectedVariant) variant = ` (${currentSelectedVariant})`;
            } else {
                // Fallback a input manual si est√° abierto el modal
                const variantInput = document.getElementById('qv-variant');
                const modalOpen = !document.getElementById('quickview-modal').classList.contains('hidden');
                if(modalOpen && variantInput && variantInput.value.trim() !== "") {
                    variant = ` (${variantInput.value.trim()})`;
                }
            }

            const cartKey = id + (variant ? `_${variant.replace(/\s/g,'')}` : '');
            
            if(cart[cartKey]) {
                cart[cartKey].qty++;
            } else {
                // Intentar usar la imagen de la variante si se seleccion√≥ una, sino la portada
                let variantImage = p.imageUrl;
                if (hasVariantsConfigured && currentSelectedVariant && p.images) {
                    const variantIndex = p.variants.indexOf(currentSelectedVariant);
                    if (variantIndex >= 0 && p.images[variantIndex]) {
                        variantImage = p.images[variantIndex];
                    }
                }

                cart[cartKey] = {
                    id: p.id,
                    nombre: p.nombre + variant,
                    precio: p.precio,
                    imageUrl: variantImage,
                    qty: 1
                };
            }
            
            saveCart(); updateCartUI(); showToast(`Agregado al carrito`);
            if (!document.getElementById('quickview-modal').classList.contains('hidden')) {
                 closeModal('quickview-modal');
            }
        }

        window.changeQty = (key, d) => {
            if(!cart[key]) return;
            const n = cart[key].qty + d;
            if(n <= 0) delete cart[key]; else cart[key].qty = n;
            saveCart(); renderCartItems(); updateCartUI();
        };

        function updateCartUI() {
            const count = Object.values(cart).reduce((a,b) => a+b.qty, 0);
            const els = ['sidebar-cart-count', 'mobile-cart-badge', 'floating-cart-btn'];
            els.forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    if(count > 0) { el.textContent = count; el.classList.remove('hidden'); if(id.includes('btn')) el.classList.add('flex'); }
                    else { el.classList.add('hidden'); if(id.includes('btn')) el.classList.remove('flex'); }
                }
            });
        }

        function renderCartItems() {
            const c = document.getElementById('cart-items-container');
            c.innerHTML = '';
            let tot = 0;
            Object.keys(cart).forEach(key => {
                const i = cart[key];
                tot += i.precio * i.qty;
                c.innerHTML += `
                <div class="flex justify-between items-center bg-stone-50 p-3 rounded-lg mb-2">
                    <div class="flex gap-3 items-center overflow-hidden">
                         <div class="w-10 h-10 bg-white rounded border flex-shrink-0 flex items-center justify-center"><img src="${i.imageUrl||''}" class="max-w-full max-h-full object-contain"></div>
                         <div class="truncate"><div class="font-bold text-xs truncate" title="${i.nombre}">${i.nombre}</div><div class="text-xs text-stone-500">$${i.precio}</div></div>
                    </div>
                    <div class="flex items-center bg-white rounded border h-7"><button onclick="changeQty('${key}', -1)" class="px-2 text-stone-400 hover:text-red-500">-</button><span class="text-xs font-bold px-1">${i.qty}</span><button onclick="changeQty('${key}', 1)" class="px-2 text-stone-400 hover:text-green-500">+</button></div>
                </div>`;
            });
            document.getElementById('cart-total-price').textContent = `$${tot.toLocaleString('es-AR')}`;
            
            const btn = document.getElementById('btn-checkout');
            if(tot===0) { 
                c.innerHTML = '<p class="text-center text-stone-400 py-10">Carrito vac√≠o</p>';
                btn.disabled = true; btn.classList.add('opacity-50');
            } else { 
                btn.disabled = false; btn.classList.remove('opacity-50'); 
            }
        }
        
        window.openCartModal = () => { renderCartItems(); document.getElementById('cart-modal').classList.remove('hidden'); document.getElementById('cart-modal').classList.add('flex'); };
        window.closeModal = (id) => { document.getElementById(id).classList.add('hidden'); document.getElementById(id).classList.remove('flex'); };
        window.goToCheckout = () => { closeModal('cart-modal'); document.getElementById('checkout-modal').classList.remove('hidden'); document.getElementById('checkout-modal').classList.add('flex'); };
        
        window.finalizeOrder = () => {
            const name = document.getElementById('customer-name').value;
            if(!name) return alert("Falta tu nombre");
            let msg = `Hola! Soy *${name}*. Pedido:\n`;
            let tot = 0;
            Object.values(cart).forEach(i => { tot+=i.precio*i.qty; msg+=`${i.qty}x ${i.nombre}\n`; });
            msg += `\nTotal: $${tot.toLocaleString('es-AR')}`;
            cart = {}; saveCart(); updateCartUI(); closeModal('checkout-modal'); navigate('home');
            window.open(`https://wa.me/${CONFIG.whatsappNumber}?text=${encodeURIComponent(msg)}`);
        };

        function saveCart() { localStorage.setItem('bm_client_cart', JSON.stringify(cart)); }
        function showToast(msg) {
            const t = document.createElement('div');
            t.className = 'bg-stone-800 text-white px-4 py-2 rounded-full shadow text-xs animate-bounce flex items-center gap-2';
            t.innerHTML = `<i class="fa-solid fa-check text-green-400"></i> ${msg}`;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(() => t.remove(), 2000);
        }
    </script>
</body>
</html>
