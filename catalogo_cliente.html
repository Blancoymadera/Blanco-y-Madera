<!DOCTYPE html>
<html lang="es">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat√°logo Blanco & Madera (Cliente)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fefce8; 
        }
        .item-card {
            transition: transform 0.1s ease-out;
        }
        .header-content {
            display: flex; 
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .logo-text {
            font-family: serif;
            font-size: 2.25rem;
            font-weight: 800;
            color: #1c1917;
            line-height: 1;
        }
        .deco-home {
            font-size: 0.75rem;
            letter-spacing: 0.3em;
            color: #78716c;
            text-align: center;
            display: block;
            margin-top: 0.1rem;
        }
        /* Ocultar el badge de stock en el cat√°logo del cliente */
        .stock-badge, .filter-container {
            display: none !important;
        }

        /* Bot√≥n Flotante para Pedidos */
        #floating-cart-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #d4a753; /* Amber */
            color: white;
            padding: 1rem;
            border-radius: 9999px; /* Fully rounded */
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            font-weight: bold;
            display: flex;
            align-items: center;
            cursor: pointer;
            z-index: 50;
            transition: background-color 0.3s;
        }
        #floating-cart-button:hover {
            background-color: #b18b45; 
        }
        #item-count-badge {
            background-color: #f87171; /* Red 400 */
            color: white;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            margin-left: 8px;
        }
        .item-card-client:hover {
            background-color: #fffaf0; /* Hover m√°s claro */
        }
        
    </style>
</head>
<body class="text-stone-800">

    <!-- HEADER FIJO -->
    <header class="bg-white shadow-lg sticky top-0 z-10">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 header-content">
            <div class="logo-container">
                <div class="flex flex-col items-center">
                    <span class="logo-text">blanco&madera</span>
                    <hr class="w-24 border-stone-400 my-0.5">
                    <span class="deco-home">DECO HOME</span>
                </div>
            </div>
            <div class="header-title-block text-center mb-1">
                <h1 class="text-3xl font-extrabold text-amber-800 tracking-wide">CAT√ÅLOGO</h1>
                <p class="text-stone-600 mt-1">Selecciona productos y env√≠anos tu pedido.</p>
                <div id="connection-status" class="text-xs text-stone-400 mt-1">Conectando...</div>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- El cliente no necesita filtros ni buscar por nombre en esta versi√≥n -->
        <!-- <div class="bg-white p-6 rounded-xl shadow-lg mb-8 filter-container">... </div> -->

        <div id="catalog-panel" class="bg-white p-6 rounded-xl shadow-lg relative min-h-[400px]">
            <h2 class="text-xl font-semibold mb-4 text-amber-800 border-b pb-2 border-stone-200">Productos Disponibles</h2>
            
            <div id="catalog-loading" class="loading-overlay">
                <div class="text-amber-600 font-bold animate-pulse">Cargando cat√°logo...</div>
            </div>
            
            <div id="product-list" class="overflow-y-auto h-[60vh] md:h-[80vh] pr-4 space-y-2">
                <p class="text-stone-500">Cargando productos...</p>
            </div>
        </div>
    </main>
    
    <!-- Bot√≥n Flotante para Enviar Pedido (WhatsApp) -->
    <div id="floating-cart-button" onclick="sendOrderToWhatsApp()">
        <span>Enviar Pedido</span>
        <span id="item-count-badge">0</span>
    </div>

    <!-- Modal de Informaci√≥n de Pedido (para datos de cliente) -->
    <div id="order-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md mx-4">
            <h3 class="text-xl font-bold mb-4 text-amber-800">Finalizar Pedido</h3>
            <p id="modal-summary" class="mb-4 text-sm text-stone-600"></p>

            <div class="mb-4">
                <label for="modal-client-name" class="block text-sm font-semibold text-stone-700 mb-1">Tu Nombre y Apellido:</label>
                <input type="text" id="modal-client-name" placeholder="Ej: Sof√≠a G√≥mez" class="w-full rounded-lg border-stone-300 p-2 focus:border-amber-600 focus:ring-amber-600">
            </div>

            <div class="mb-6">
                <label for="modal-whatsapp-number" class="block text-sm font-semibold text-stone-700 mb-1">Tu WhatsApp (549...):</label>
                <input type="tel" id="modal-whatsapp-number" placeholder="Ej: 5493415551234 (Opcional)" class="w-full rounded-lg border-stone-300 p-2 focus:border-amber-600 focus:ring-amber-600">
            </div>

            <div class="flex justify-between space-x-3">
                <button onclick="closeOrderModal()" class="w-1/2 bg-stone-300 text-stone-800 font-bold py-2 rounded-lg hover:bg-stone-400 transition">Cancelar</button>
                <button onclick="confirmAndSendOrder()" class="w-1/2 bg-green-600 text-white font-bold py-2 rounded-lg hover:bg-green-700 transition">
                    Enviar a WhatsApp
                </button>
            </div>
        </div>
    </div>
    
    <!-- Contenedor de Notificaciones -->
    <div id="toast-container"></div>

    <!-- IMPORTANTE: M√≥dulo para Firebase (SOLO LECTURA) -->
    <script type="module">
        // --- CONFIGURACI√ìN DE FIREBASE (MISMA QUE EL CAT√ÅLOGO INTERNO) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, collection, getDocs, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBeaZnBmmqd2kmgLjxaJvG33VYlAdKU5Y",
            authDomain: "blanco-y-madera-17214.firebaseapp.com",
            projectId: "blanco-y-madera-17214",
            storageBucket: "blanco-y-madera-17214.appspot.com",
            messagingSenderId: "147976695842",
            appId: "1:147976695842:web:e165092b1fee5aa1e99a7b",
            measurementId: "G-MHKJVMLRVL"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // --- VARIABLES GLOBALES ---
        let productData = []; // Se llenar√° desde Firebase
        let cart = {}; 
        let uniqueIdCounter = 0; // Se usar√° solo para dar ID local a los √≠tems del carrito
        
        // --- FUNCIONES DE BASE DE DATOS (SOLO LECTURA) ---

        function subscribeToProducts() {
            const q = collection(db, "products");
            const loadingElement = document.getElementById('catalog-loading');
            
            onSnapshot(q, (querySnapshot) => {
                productData = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (!data.id) data.id = doc.id; 
                    productData.push(data);
                });

                // Inicializar o re-renderizar
                renderProductList(productData);
                renderFloatingCart();
                loadingElement.style.display = 'none'; 
                document.getElementById('connection-status').textContent = "Sincronizado y Listo";
                document.getElementById('connection-status').classList.add('text-green-600');
            }, (error) => {
                console.error("Error al suscribirse a la DB:", error);
                document.getElementById('connection-status').textContent = "ERROR de Carga üî¥";
                loadingElement.innerHTML = `<div class="text-red-600 font-bold">Error al cargar productos.</div>`;
            });
        }
        
        // --- L√ìGICA DEL CARRITO (Local para el Cliente) ---

        function formatCurrency(value) {
            return new Intl.NumberFormat('es-AR', {
                style: 'currency',
                currency: 'ARS',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        window.addToCart = function(id) {
            const product = productData.find(p => p.id === id);
            
            if (!product) return;

            // En este cat√°logo no checamos el stock, solo permitimos agregar.

            if (cart[id]) {
                cart[id].cantidad += 1;
            } else {
                cart[id] = { 
                    id: id, 
                    nombre: product.nombre,
                    precio: product.precio,
                    cantidad: 1 
                };
            }
            showToast(`¬°Agregado! ${product.nombre}`);
            renderFloatingCart();
        };
        
        function calculateSubtotalWithoutDiscount() {
            let subtotal = 0;
            for (const id in cart) {
                const item = cart[id];
                subtotal += Number(item.precio) * item.cantidad;
            }
            return subtotal;
        }

        function getCartItemCount() {
            let count = 0;
            for (const id in cart) {
                count += cart[id].cantidad;
            }
            return count;
        }
        
        function renderFloatingCart() {
            const itemCountBadge = document.getElementById('item-count-badge');
            const count = getCartItemCount();
            itemCountBadge.textContent = count;
            
            const floatingButton = document.getElementById('floating-cart-button');
            if (count > 0) {
                floatingButton.style.display = 'flex';
                floatingButton.style.transform = 'scale(1)';
            } else {
                floatingButton.style.transform = 'scale(0)';
            }
        }
        
        // --- L√ìGICA DE COMPARTIR PEDIDO ---
        
        window.sendOrderToWhatsApp = function() {
            const total = calculateSubtotalWithoutDiscount();
            const count = getCartItemCount();
            
            if (count === 0) {
                alert("Tu carrito est√° vac√≠o. Agrega productos para enviar un pedido.");
                return;
            }

            // Llenar resumen en el modal
            document.getElementById('modal-summary').textContent = 
                `Tienes ${count} producto(s) en tu pedido con un total estimado de ${formatCurrency(total)}.`;
            
            document.getElementById('order-modal').style.display = 'flex';
        }
        
        window.closeOrderModal = function() {
            document.getElementById('order-modal').style.display = 'none';
        }
        
        window.confirmAndSendOrder = function() {
            const clientName = document.getElementById('modal-client-name').value.trim();
            const clientWhatsApp = document.getElementById('modal-whatsapp-number').value.trim().replace(/\D/g, '');

            if (!clientName) {
                alert("Por favor, ingresa tu Nombre y Apellido.");
                return;
            }
            
            let subtotal = 0;
            const items = [];

            for (const id in cart) {
                const item = cart[id];
                const itemSubtotal = item.precio * item.cantidad;
                subtotal += itemSubtotal;
                items.push({ nombre: item.nombre, cantidad: item.cantidad, subtotal: itemSubtotal });
            }
            
            const formattedDate = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });

            // Mensaje que t√∫ (el vendedor) recibir√°s
            const summaryLines = [
                `üõí *NUEVO PEDIDO WEB DE CLIENTE*`,
                `-----------------------------------`,
                `üë§ Cliente: *${clientName}*`,
                `üìû WhatsApp: ${clientWhatsApp || 'No especificado'}`,
                `üìÖ Fecha: ${formattedDate}`,
                `-----------------------------------`,
                `*DETALLE DE PRODUCTOS:*`
            ];

            items.forEach((item) => {
                // El cliente env√≠a la lista de productos y sus precios
                summaryLines.push(` ‚Ä¢ ${item.nombre} x ${item.cantidad}: ${formatCurrency(item.subtotal)}`);
            });

            summaryLines.push(`\n*TOTAL ESTIMADO: ${formatCurrency(subtotal)}*`);
            summaryLines.push(`\n_Por favor, confirma el total y la disponibilidad de stock._`);


            const whatsappText = encodeURIComponent(summaryLines.join('\n'));
            
            // Abre WhatsApp con TU n√∫mero (o el n√∫mero del local, asumido)
            // Ya que el n√∫mero de destino debe ser el tuyo y no el del cliente, usar√© un n√∫mero ficticio. 
            // Si el cliente ingresa su n√∫mero, se usa solo para el mensaje.
            const yourWhatsAppNumber = '5493415550000'; // <--- REEMPLAZA ESTE N√öMERO POR EL N√öMERO DEL LOCAL
            
            const whatsappUrl = `https://wa.me/${yourWhatsAppNumber}?text=${whatsappText}`;
            
            // Limpia el carrito del cliente
            cart = {};
            renderFloatingCart();
            closeOrderModal();
            
            showToast("¬°Pedido enviado! Abriendo WhatsApp...");
            
            window.open(whatsappUrl, '_blank');
        }
        

        // --- FUNCIONES DE RENDERIZADO ---
        
        function showToast(message) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => container.removeChild(toast), 300);
            }, 2000);
        }
        
        function renderProductList(data) {
            const productList = document.getElementById('product-list');
            productList.innerHTML = ''; 

            if (data.length === 0) {
                productList.innerHTML = '<p class="text-stone-500">No se encontraron productos que coincidan con su b√∫squeda.</p>';
                return;
            }

            data.forEach(product => {
                const item = document.createElement('div');
                // No hay l√≥gica de stock para el cliente, pero la opacidad se basa en si hay > 0 stock (dato que lee de la DB)
                const isOutOfStock = product.stock <= 0;
                const opacityClass = isOutOfStock ? 'opacity-60' : '';
                
                item.className = `bg-white p-4 rounded-xl border border-stone-100 flex justify-between items-center item-card-client ${opacityClass}`;
                
                // Estructura de la tarjeta
                item.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <!-- Placeholder de Imagen (Si existe la URL en el futuro) -->
                        <div class="w-16 h-16 bg-stone-100 rounded-lg flex items-center justify-center overflow-hidden">
                            ${product.imageUrl ? `<img src="${product.imageUrl}" alt="${product.nombre}" class="object-cover w-full h-full">` : `<span class="text-xs text-stone-400">üñºÔ∏è</span>`}
                        </div>

                        <!-- Info del Producto -->
                        <div>
                            <p class="font-semibold text-lg text-stone-800">${product.nombre}</p>
                            <p class="text-xs text-stone-500">${product.categoria}</p>
                            <!-- El stock se OCULTA por CSS pero se mantiene la estructura -->
                            <span class="stock-badge text-xs px-2 py-0.5 rounded-full font-medium bg-red-400 text-white">
                                üì¶ Sin Stock
                            </span>
                        </div>
                    </div>

                    <!-- Precio y Bot√≥n -->
                    <div class="flex items-center space-x-3">
                        <span class="text-xl font-extrabold text-amber-800">${formatCurrency(product.precio)}</span>
                        <button onclick="addToCart('${product.id}')" class="p-2 bg-green-500 text-white rounded-lg shadow-md hover:bg-green-600 transition focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2"
                            ${isOutOfStock ? 'disabled' : ''}>
                            <span class="text-xl">üõí</span>
                        </button>
                    </div>
                `;
                productList.appendChild(item);
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
             // 1. Conectarse a la sincronizaci√≥n en tiempo real (solo lectura)
             subscribeToProducts(); 
        });
    </script>
</body>
</html>
